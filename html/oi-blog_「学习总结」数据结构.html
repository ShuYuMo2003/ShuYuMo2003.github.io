<!-- Academic Blog Template
MIT License - Copyright (c) 2025 Su Jiayi <sujiayi2003@gmail.com>
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        
        <!-- Primary Meta Tags -->
        <title>ShuYuMo&#39;s Blog | Jiayi Su</title>
        <meta name="description" content="一些奇奇怪怪的 INFP 随碎碎念。">
        <meta name="keywords" content="nb1, nb2, nb3">
        <meta name="author" content="Su Jiayi">
        
        <!-- Open Graph Meta Tags -->
        <meta property="og:type" content="website">
        <meta property="og:title" content="ShuYuMo&#39;s Blog | Jiayi Su">
        <meta property="og:description" content="一些奇奇怪怪的 INFP 随碎碎念。">
        <meta property="og:image" content="../static/images/header.jpg">
        
        <!-- Stylesheets -->
        <link rel="stylesheet" type="text/css" href="../static/css/default.css">
        <link rel="stylesheet" type="text/css" href="../static/css/syntax.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
        
        <!-- Google Analytics -->
        
    </head>
    <body>
        <!-- Skip to main content for accessibility -->
        <a href="#main-content" class="skip-link">Skip to main content</a>
        
        <div id="main">
            <div class="main-container">
                <!-- Header -->
                <header id="header">
                    <div class="header-content">
                        <h1 class="header-title">
                            <a href="./">ShuYuMo&#39;s Blog</a>
                        </h1>
                        <p class="header-subtitle">一些奇奇怪怪的 INFP 随碎碎念。</p>
                        <div class="header-accent"></div>
                    </div>
                </header>
                
                <!-- Content Layout -->
                <div class="content-wrapper">
                    <!-- Sidebar -->
                    <nav id="sidebar">
                        <div class="profile-section">
                            <a href="./" class="profile-avatar-link">
                                <img src="../static/images/header.jpg" alt="ShuYuMo&#39;s header" class="profile-avatar" loading="lazy" />
                            </a>
                            <div class="profile-info">
                                <h3 class="profile-name">Jiayi Su (ShuYuMo)</h3>
            </div>
            </div>

                        <div class="nav-header">
                            <h2>🧭 Navigation</h2>
                            <span class="nav-subtitle">Explore the site</span>
                        </div>
                        <nav class="nav-menu">
                            
                            
                            <a href="./_post.html" 
                               
                               class="nav-item">
                                <span class="nav-icon">📄</span>
                                <span class="nav-text">Posts</span>
                                
                            </a>
                            
                            
                            <a href="./_archive.html" 
                               
                               class="nav-item">
                                <span class="nav-icon">📄</span>
                                <span class="nav-text">Archive</span>
                                
                            </a>
                            
                            
                            <a href="./_category.html" 
                               
                               class="nav-item">
                                <span class="nav-icon">📄</span>
                                <span class="nav-text">Category</span>
                                
                            </a>
                            
                            
                            <a href="./_about.html" 
                               
                               class="nav-item">
                                <span class="nav-icon">📄</span>
                                <span class="nav-text">About</span>
                                
                            </a>
                            
                        </nav>
                    </nav>

                    <!-- Main Content -->
                    <main id="content">
                        <div id="main-content">
                            
                                <article>
                                    <!-- Article Header with Title and Actions -->
                                    <div class="article-header">
                                        <div class="article-title-section">
                                            
                                                <h1 class="article-title">「学习总结」数据结构</h1>
                                            
                                            
                                            <!-- Article Meta Information -->
                                            <div class="article-meta">
                                                
                                                    <div class="meta-item">
                                                        <span class="meta-icon">📅</span>
                                                        <span class="meta-label">Last Updated: </span>
                                                        <span class="meta-value">2020-12-20</span>
                                                    </div>
                                                
                                                
                                                
                                                    <div class="meta-item">
                                                        <span class="meta-icon">📊</span>
                                                        <span class="meta-label">Word Count: </span>
                                                        <span class="meta-value">1123</span>
                                                    </div>
                    

                                                
                                                    <div class="meta-item">
                                                        <span class="meta-icon">⏱️</span>
                                                        <span class="meta-label">Estimated Reading Time: </span>
                                                        <span class="meta-value">7 minutes</span>
                                                    </div>
                                                
                                            </div>
                                        </div>
                                        
                                        <div class="article-actions">
                    
                                                <a href="../pdf/oi-blog_「学习总结」数据结构.pdf" 
                                                   target="_blank" 
                                                   rel="noopener"
                                                   class="action-btn pdf-btn">
                                                    📄 PDF
                                                </a>
                                            
                                            
                                            
                                                <a href="../src/oi-blog/「学习总结」数据结构.md" 
                                                   target="_blank" 
                                                   rel="noopener"
                                                   class="action-btn source-btn">
                                                    📝 Source
                                                </a>
                                            
                                        </div>
                                    </div>

                                    <!-- Article Content -->
                                    <div class="article-content">
                                        <p><del>真的好爱 <code>Splay</code>!</del></p>
<p>好像只有 <code>LCT</code> 中才有必要写 <code>Splay</code> 吧…… 其实
<code>非旋 Treap</code> 真的是又短，有小，又快……</p>
<!-- more -->
<h1 id="数据结构">数据结构</h1>
<h2 id="平衡树">平衡树</h2>
<h3 id="splay">Splay</h3>
<ul>
<li>删除结点时，不是 <code>Splay</code>
到根然后合并两边的子树，而是将待删除的结点前驱 <code>Splay</code>
到根节点， 后继 <code>Splay</code> 到根节点右儿子，那么待删除的结点就在
<code>ls(rs(rt))</code>
上。这样可以删除集合内一个区间的元素，也方便后面维护序列。
<!-- more --></li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> erase<span class="op">(</span><span class="dt">int</span> v<span class="op">){</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    PII pre <span class="op">=</span> _pred<span class="op">(</span>v<span class="op">),</span> nxt <span class="op">=</span> _nxtd<span class="op">(</span>v<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    splay<span class="op">(</span>pre<span class="op">.</span>se<span class="op">);</span> splay<span class="op">(</span>nxt<span class="op">.</span>se<span class="op">,</span> rt<span class="op">);</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">&amp;</span>target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> cnt<span class="op">[</span>target<span class="op">]</span> <span class="op">--;</span> si<span class="op">[</span>target<span class="op">]--;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>cnt<span class="op">[</span>target<span class="op">])</span> target <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    maintain<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> maintain<span class="op">(</span>ls<span class="op">(</span>rt<span class="op">));</span>  maintain<span class="op">(</span>rt<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>如果空间要求较严格，可以考虑手写一个小的内存管理函数，删除时回收内存，新增元素时优先使用之前删除的结点内存。</li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>stack<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> Mem<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> make<span class="op">(){</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> t<span class="op">;</span> <span class="dt">int</span> o <span class="op">=</span> <span class="op">(</span>Mem<span class="op">.</span>empty<span class="op">()</span> <span class="op">?</span> <span class="op">++</span>tot <span class="op">:</span> <span class="op">(</span>t <span class="op">=</span> Mem<span class="op">.</span>top<span class="op">(),</span> Mem<span class="op">.</span>pop<span class="op">(),</span> t<span class="op">));</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    ch<span class="op">[</span>o<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>o<span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> v<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> fa<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    si<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> o<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> recycle<span class="op">(</span><span class="dt">int</span> o <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span> <span class="cf">if</span><span class="op">(</span>o <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> o <span class="op">=</span> rt<span class="op">;</span> <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> <span class="op">;</span> Mem<span class="op">.</span>push<span class="op">(</span>o<span class="op">);</span> recycle<span class="op">(</span>ls<span class="op">(</span>o<span class="op">));</span> recycle<span class="op">(</span>rs<span class="op">(</span>o<span class="op">));</span> <span class="op">}</span></span></code></pre></div>
<ul>
<li>如果需要开多棵 <code>Splay</code>，可以考虑只封装每棵
<code>Splay</code> 的根节点，对于结点内存的申请和释放统一管理</li>
<li>一个很方便的调试 <code>Splay</code> 的函数：</li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dfs<span class="op">(</span><span class="dt">int</span> o <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">int</span> indent <span class="op">=</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>o <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> o <span class="op">=</span> rt<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span>  <span class="op">{</span> cerr <span class="op">&lt;&lt;</span> string<span class="op">(</span>indent<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;# null&quot;</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> <span class="cf">return</span> <span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">assert</span><span class="op">(!</span>rs<span class="op">(</span>o<span class="op">)</span> <span class="op">||</span> fa<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)]</span> <span class="op">==</span> o<span class="op">);</span> dfs<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> indent <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    cerr <span class="op">&lt;&lt;</span> string<span class="op">(</span>indent<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;# v=&quot;</span> <span class="op">&lt;&lt;</span> val<span class="op">[</span>o<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">&quot; ans=&quot;</span> <span class="op">&lt;&lt;</span> v<span class="op">[</span>o<span class="op">].</span>ans <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">assert</span><span class="op">(!</span>ls<span class="op">(</span>o<span class="op">)</span> <span class="op">||</span> fa<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">==</span> o<span class="op">);</span> dfs<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> indent <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>建立哨兵结点作为整个 <code>Splay</code>
的最小最大值是一个通用技巧，删除操作依赖于前驱和后继结点，所以哨兵结点时必要的。维护序列时注意消除哨兵结点对答案的影响。</li>
</ul>
<h4 id="维护集合">维护集合</h4>
<p>一种动态维护集合元素，查询集合元素信息的解决方案。 -
为了优化常数和简化代码，查询前驱后继不再采用 <code>插入-删除</code>
式查询。查询元素排名之后直接选取前驱和后继即可。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>PII _pred<span class="op">(</span><span class="dt">int</span> v<span class="op">){</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    PII res <span class="op">=</span> rank<span class="op">(</span>rt<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> select<span class="op">(</span>rt<span class="op">,</span> res<span class="op">.</span>fi <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="dt">int</span> pred<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span> PII res <span class="op">=</span> _pred<span class="op">(</span>v<span class="op">);</span> splay<span class="op">(</span>res<span class="op">.</span>se<span class="op">);</span> <span class="cf">return</span> res<span class="op">.</span>fi<span class="op">;</span> <span class="op">}</span></span></code></pre></div>
<ul>
<li><code>rank</code> 和 <code>select</code> 返回值为
<code>pair&lt;int, int&gt;</code>
其中，前一个指答案，后一个是作用结点，方便后期获取结点信息（<code>Splay</code>）。
<code>int rank(int v) { PII res = rank(rt, v); if(res.se) splay(res.se); return res.fi - 1; }</code></li>
</ul>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="dt">Splay_t</span><span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ch<span class="op">[</span>_<span class="op">][</span><span class="dv">2</span><span class="op">],</span> cnt<span class="op">[</span>_<span class="op">],</span> si<span class="op">[</span>_<span class="op">],</span> v<span class="op">[</span>_<span class="op">],</span> fa<span class="op">[</span>_<span class="op">],</span> tot<span class="op">,</span> rt<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">typedef</span> pair<span class="op">&lt;</span><span class="dt">int</span><span class="op">,</span> <span class="dt">int</span><span class="op">&gt;</span> PII<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define ls</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">0</span><span class="op">])</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define rs</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define maintain</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>si<span class="op">[</span>o<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>cnt<span class="op">[</span>o<span class="op">]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>si<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)])</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define get</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>o<span class="pp"> </span><span class="op">==</span><span class="pp"> </span>ch<span class="op">[</span>fa<span class="op">[</span>o<span class="op">]][</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> make<span class="op">(</span><span class="dt">int</span> f<span class="op">,</span> <span class="dt">int</span> V<span class="op">){</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        tot<span class="op">++;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        si<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> cnt<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        fa<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> f<span class="op">;</span> v<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> V<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>f<span class="op">)</span> ch<span class="op">[</span>f<span class="op">][</span>v<span class="op">[</span>f<span class="op">]</span> <span class="op">&lt;</span> V<span class="op">]</span> <span class="op">=</span> tot<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tot<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> rotate<span class="op">(</span><span class="dt">int</span> o<span class="op">){</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> p <span class="op">=</span> fa<span class="op">[</span>o<span class="op">],</span> gp <span class="op">=</span> fa<span class="op">[</span>fa<span class="op">[</span>o<span class="op">]],</span> chk <span class="op">=</span> get<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        ch<span class="op">[</span>p<span class="op">][</span>chk<span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>o<span class="op">][</span>chk<span class="op">^</span><span class="dv">1</span><span class="op">];</span> fa<span class="op">[</span>ch<span class="op">[</span>o<span class="op">][</span>chk<span class="op">^</span><span class="dv">1</span><span class="op">]]</span> <span class="op">=</span> p<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        ch<span class="op">[</span>o<span class="op">][</span>chk<span class="op">^</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> p<span class="op">;</span> fa<span class="op">[</span>p<span class="op">]</span> <span class="op">=</span> o<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        fa<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> gp<span class="op">;</span> <span class="cf">if</span><span class="op">(</span>gp<span class="op">)</span> ch<span class="op">[</span>gp<span class="op">][</span>ch<span class="op">[</span>gp<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">==</span> p<span class="op">]</span> <span class="op">=</span> o<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        maintain<span class="op">(</span>p<span class="op">);</span> maintain<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> splay<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> tgp <span class="op">=</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> f <span class="op">=</span> fa<span class="op">[</span>o<span class="op">];</span> f <span class="op">=</span> fa<span class="op">[</span>o<span class="op">],</span> f <span class="op">!=</span> tgp<span class="op">;</span> rotate<span class="op">(</span>o<span class="op">))</span> <span class="cf">if</span><span class="op">(</span>fa<span class="op">[</span>f<span class="op">]</span> <span class="op">!=</span> tgp<span class="op">)</span> rotate<span class="op">(</span>get<span class="op">(</span>o<span class="op">)</span> <span class="op">==</span> get<span class="op">(</span>f<span class="op">)</span> <span class="op">?</span> f <span class="op">:</span> o<span class="op">);</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>tgp<span class="op">)</span> rt <span class="op">=</span> o<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ins<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> f<span class="op">,</span> <span class="dt">int</span> V<span class="op">){</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> make<span class="op">(</span>f<span class="op">,</span> V<span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>v<span class="op">[</span>o<span class="op">]</span> <span class="op">==</span> V<span class="op">)</span> <span class="cf">return</span> <span class="op">(</span>cnt<span class="op">[</span>o<span class="op">]++,</span> si<span class="op">[</span>o<span class="op">]++,</span> o<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> r<span class="op">;</span> <span class="cf">return</span> <span class="op">(</span>r <span class="op">=</span> ins<span class="op">(</span>V <span class="op">&lt;</span> v<span class="op">[</span>o<span class="op">]</span> <span class="op">?</span> ls<span class="op">(</span>o<span class="op">)</span> <span class="op">:</span> rs<span class="op">(</span>o<span class="op">),</span> o<span class="op">,</span> V<span class="op">),</span> maintain<span class="op">(</span>o<span class="op">),</span> r<span class="op">);</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">void</span> ins<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span> <span class="dt">int</span> t <span class="op">=</span> ins<span class="op">(</span>rt<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> v<span class="op">);</span> splay<span class="op">(</span>t<span class="op">);</span> <span class="op">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    PII rank<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> V<span class="op">){</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> mp<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>V <span class="op">==</span> v<span class="op">[</span>o<span class="op">])</span> <span class="cf">return</span> mp<span class="op">(</span>si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> o<span class="op">);</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        PII res<span class="op">;</span> </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>V <span class="op">&lt;</span> v<span class="op">[</span>o<span class="op">])</span> <span class="cf">return</span> rank<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> V<span class="op">);</span> </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">return</span> <span class="op">(</span>res <span class="op">=</span> rank<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> V<span class="op">),</span> res<span class="op">.</span>fi <span class="op">+=</span> cnt<span class="op">[</span>o<span class="op">]</span> <span class="op">+</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)],</span> res<span class="op">);</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">int</span> rank<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span> PII res <span class="op">=</span> rank<span class="op">(</span>rt<span class="op">,</span> v<span class="op">);</span> <span class="cf">if</span><span class="op">(</span>res<span class="op">.</span>se<span class="op">)</span> splay<span class="op">(</span>res<span class="op">.</span>se<span class="op">);</span> <span class="cf">return</span> res<span class="op">.</span>fi <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    PII select<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> k<span class="op">){</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>k <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)])</span> <span class="cf">return</span> select<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> k<span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>k <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">+</span> cnt<span class="op">[</span>o<span class="op">])</span> <span class="cf">return</span> mp<span class="op">(</span>v<span class="op">[</span>o<span class="op">],</span> o<span class="op">);</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">return</span> select<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> k <span class="op">-</span> cnt<span class="op">[</span>o<span class="op">]</span> <span class="op">-</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]);</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">int</span> select<span class="op">(</span><span class="dt">int</span> k<span class="op">)</span> <span class="op">{</span> PII res <span class="op">=</span> select<span class="op">(</span>rt<span class="op">,</span> k <span class="op">+</span> <span class="dv">1</span><span class="op">);</span> splay<span class="op">(</span>res<span class="op">.</span>se<span class="op">);</span> <span class="cf">return</span> res<span class="op">.</span>fi<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    PII _pred<span class="op">(</span><span class="dt">int</span> v<span class="op">){</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        PII res <span class="op">=</span> rank<span class="op">(</span>rt<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> select<span class="op">(</span>rt<span class="op">,</span> res<span class="op">.</span>fi <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">int</span> pred<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span> PII res <span class="op">=</span> _pred<span class="op">(</span>v<span class="op">);</span> splay<span class="op">(</span>res<span class="op">.</span>se<span class="op">);</span> <span class="cf">return</span> res<span class="op">.</span>fi<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    PII _nxtd<span class="op">(</span><span class="dt">int</span> v<span class="op">){</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        PII res <span class="op">=</span> rank<span class="op">(</span>rt<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> select<span class="op">(</span>rt<span class="op">,</span> res<span class="op">.</span>fi <span class="op">+</span> cnt<span class="op">[</span>res<span class="op">.</span>se<span class="op">]);</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">int</span> nxtd<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span> PII res <span class="op">=</span> _nxtd<span class="op">(</span>v<span class="op">);</span> splay<span class="op">(</span>res<span class="op">.</span>se<span class="op">);</span> <span class="cf">return</span> res<span class="op">.</span>fi<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> erase<span class="op">(</span><span class="dt">int</span> v<span class="op">){</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        PII pre <span class="op">=</span> _pred<span class="op">(</span>v<span class="op">),</span> nxt <span class="op">=</span> _nxtd<span class="op">(</span>v<span class="op">);</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        splay<span class="op">(</span>pre<span class="op">.</span>se<span class="op">);</span> splay<span class="op">(</span>nxt<span class="op">.</span>se<span class="op">,</span> rt<span class="op">);</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> <span class="op">&amp;</span>target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> cnt<span class="op">[</span>target<span class="op">]</span> <span class="op">--;</span> si<span class="op">[</span>target<span class="op">]--;</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>cnt<span class="op">[</span>target<span class="op">])</span> target <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        maintain<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> maintain<span class="op">(</span>ls<span class="op">(</span>rt<span class="op">));</span>  maintain<span class="op">(</span>rt<span class="op">);</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Splay_t</span><span class="op">(){</span> tot <span class="op">=</span> rt <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ins<span class="op">(</span>INT_MAX<span class="op">);</span> ins<span class="op">(</span>INT_MIN<span class="op">);</span> <span class="op">}</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 id="维护序列">维护序列</h4>
<p>一种支持增删元素的，线段树替代方案。
本质上和线段的思想很相似，一样采用信息合并和懒标记优化复杂度，每个结点也和线段树一样存储一个子区间的信息。
唯一不同的就是线段树是一种
<code>Leafy Tree</code>，即所有信息都只存储在叶子结点上，其结构导致无法删除和新增元素。
-
注意懒标记和线段树的定义是一样的，其作用节点的信息首先被修改。类比线段树的懒标记直接写就好了。
-
平衡树合并信息和线段树合并信息不同点在于：线段树是合并两边的信息，平衡树是先合并左子结点信息和中间结点信息再与有子结点合并，其实还是因为线段树是一种
<code>Leafy Tree</code> —— 和平衡树有本质区别。 - 因为
<code>Splay</code>
可以相对较好的控制树的形态，可以让一个子树组成任意区间，所以能够很好的维护序列。
- 核心操作：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Make_Range<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">){</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pre <span class="op">=</span> find<span class="op">(</span>rt<span class="op">,</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">),</span> suf <span class="op">=</span> find<span class="op">(</span>rt<span class="op">,</span> R <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    splay<span class="op">(</span>pre<span class="op">);</span> splay<span class="op">(</span>suf<span class="op">,</span> rt<span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> _ <span class="op">=</span> <span class="fl">5e5</span> <span class="op">+</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="dt">Splay_t</span><span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    stack<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> Mem<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define none </span><span class="op">(-</span><span class="dv">30000</span><span class="op">)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> <span class="dt">data_t</span><span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> sum<span class="op">,</span> per<span class="op">,</span> suf<span class="op">,</span> ans<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data_t</span><span class="op">(){</span> per <span class="op">=</span> suf <span class="op">=</span> ans <span class="op">=</span> <span class="op">-</span><span class="fl">1e9</span><span class="op">;</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data_t</span><span class="op">(</span><span class="dt">int</span> V<span class="op">)</span> <span class="op">{</span> sum <span class="op">=</span> per <span class="op">=</span> suf <span class="op">=</span> ans <span class="op">=</span> V<span class="op">;</span> <span class="op">}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> ret<span class="op">(</span><span class="dt">int</span> v<span class="op">,</span> <span class="dt">int</span> len<span class="op">){</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>v <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">)</span> suf <span class="op">=</span> per <span class="op">=</span> ans <span class="op">=</span> v<span class="op">,</span> sum <span class="op">=</span> v <span class="op">*</span> len<span class="op">;</span> <span class="co">// changed `sum = v` to `sum = v * len`.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>       sum <span class="op">=</span> suf <span class="op">=</span> per <span class="op">=</span> ans <span class="op">=</span> v <span class="op">*</span> len<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> rev<span class="op">()</span> <span class="op">{</span> swap<span class="op">(</span>per<span class="op">,</span> suf<span class="op">);</span> <span class="op">}</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data_t</span> <span class="kw">operator</span> <span class="op">+</span> <span class="op">(</span><span class="at">const</span> <span class="dt">data_t</span> <span class="op">&amp;</span> B<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">data_t</span> A <span class="op">=</span> <span class="op">*</span><span class="kw">this</span><span class="op">,</span> res<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            res<span class="op">.</span>sum <span class="op">=</span> A<span class="op">.</span>sum <span class="op">+</span> B<span class="op">.</span>sum<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            res<span class="op">.</span>per <span class="op">=</span> max<span class="op">(</span>A<span class="op">.</span>per<span class="op">,</span> A<span class="op">.</span>sum <span class="op">+</span> B<span class="op">.</span>per<span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            res<span class="op">.</span>suf <span class="op">=</span> max<span class="op">(</span>A<span class="op">.</span>suf <span class="op">+</span> B<span class="op">.</span>sum<span class="op">,</span> B<span class="op">.</span>suf<span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            res<span class="op">.</span>ans <span class="op">=</span> max<span class="op">(</span>max<span class="op">(</span>A<span class="op">.</span>ans<span class="op">,</span> B<span class="op">.</span>ans<span class="op">),</span> A<span class="op">.</span>suf <span class="op">+</span> B<span class="op">.</span>per<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ch<span class="op">[</span>_<span class="op">][</span><span class="dv">2</span><span class="op">],</span> fa<span class="op">[</span>_<span class="op">],</span> si<span class="op">[</span>_<span class="op">],</span> rt<span class="op">,</span> tot<span class="op">;</span> <span class="dt">data_t</span> v<span class="op">[</span>_<span class="op">];</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> val<span class="op">[</span>_<span class="op">];</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> tag_rev<span class="op">[</span>_<span class="op">];</span> <span class="dt">short</span> tag_ret<span class="op">[</span>_<span class="op">];</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define ls</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">0</span><span class="op">])</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define rs</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define maintain</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>si<span class="op">[</span>o<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>si<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">1</span><span class="op">,</span><span class="pp"> </span>v<span class="op">[</span>o<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>v<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dt">data_t</span><span class="op">(</span>val<span class="op">[</span>o<span class="op">])</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>v<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)])</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define get</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>fa<span class="op">[</span>o<span class="op">]][</span><span class="dv">1</span><span class="op">]</span><span class="pp"> </span><span class="op">==</span><span class="pp"> </span>o<span class="op">)</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> make<span class="op">(){</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>Mem<span class="op">.</span>empty<span class="op">()){</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> o <span class="op">=</span> Mem<span class="op">.</span>top<span class="op">();</span> Mem<span class="op">.</span>pop<span class="op">();</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            tag_ret<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> none<span class="op">;</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>            tag_rev<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            ch<span class="op">[</span>o<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>o<span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> si<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> val<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> fa<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            v<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dt">data_t</span><span class="op">();</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o<span class="op">;</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            tot<span class="op">++;</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            tag_ret<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> none<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            tag_rev<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> si<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> val<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> fa<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            v<span class="op">[</span>tot<span class="op">]</span> <span class="op">=</span> <span class="dt">data_t</span><span class="op">();</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> tot<span class="op">;</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> recycle<span class="op">(</span><span class="dt">int</span> o<span class="op">){</span> <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> <span class="op">;</span> Mem<span class="op">.</span>push<span class="op">(</span>o<span class="op">);</span> recycle<span class="op">(</span>ls<span class="op">(</span>o<span class="op">));</span> recycle<span class="op">(</span>rs<span class="op">(</span>o<span class="op">));</span> <span class="op">}</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Splay_t</span><span class="op">()</span> <span class="op">{</span> rt <span class="op">=</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> tar_rev<span class="op">(</span><span class="dt">int</span> o<span class="op">){</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        v<span class="op">[</span>o<span class="op">].</span>rev<span class="op">();</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        swap<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> rs<span class="op">(</span>o<span class="op">));</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        tag_rev<span class="op">[</span>o<span class="op">]</span> <span class="op">^=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> tar_ret<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> V<span class="op">){</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        v<span class="op">[</span>o<span class="op">].</span>ret<span class="op">(</span>V<span class="op">,</span> si<span class="op">[</span>o<span class="op">]);</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        val<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> V<span class="op">;</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        tag_ret<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> V<span class="op">;</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> push<span class="op">(</span><span class="dt">int</span> o<span class="op">){</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>tag_ret<span class="op">[</span>o<span class="op">]</span> <span class="op">!=</span> none<span class="op">){</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>ls<span class="op">(</span>o<span class="op">))</span> tar_ret<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> tag_ret<span class="op">[</span>o<span class="op">]);</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>rs<span class="op">(</span>o<span class="op">))</span> tar_ret<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> tag_ret<span class="op">[</span>o<span class="op">]);</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            tag_ret<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> none<span class="op">;</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>tag_rev<span class="op">[</span>o<span class="op">]){</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>ls<span class="op">(</span>o<span class="op">))</span>tar_rev<span class="op">(</span>ls<span class="op">(</span>o<span class="op">));</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>rs<span class="op">(</span>o<span class="op">))</span>tar_rev<span class="op">(</span>rs<span class="op">(</span>o<span class="op">));</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            tag_rev<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> rotate<span class="op">(</span><span class="dt">int</span> o<span class="op">){</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> p <span class="op">=</span> fa<span class="op">[</span>o<span class="op">],</span> gp <span class="op">=</span> fa<span class="op">[</span>fa<span class="op">[</span>o<span class="op">]],</span> chk <span class="op">=</span> get<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        ch<span class="op">[</span>p<span class="op">][</span>chk<span class="op">]</span> <span class="op">=</span> ch<span class="op">[</span>o<span class="op">][</span>chk <span class="op">^</span> <span class="dv">1</span><span class="op">];</span> fa<span class="op">[</span>ch<span class="op">[</span>o<span class="op">][</span>chk <span class="op">^</span> <span class="dv">1</span><span class="op">]]</span> <span class="op">=</span> p<span class="op">;</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        ch<span class="op">[</span>o<span class="op">][</span>chk <span class="op">^</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> p<span class="op">;</span> fa<span class="op">[</span>p<span class="op">]</span> <span class="op">=</span> o<span class="op">;</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        fa<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> gp<span class="op">;</span> <span class="cf">if</span><span class="op">(</span>gp<span class="op">)</span> ch<span class="op">[</span>gp<span class="op">][</span>ch<span class="op">[</span>gp<span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">==</span> p<span class="op">]</span> <span class="op">=</span> o<span class="op">;</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        maintain<span class="op">(</span>p<span class="op">);</span> maintain<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> splay<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> tgp <span class="op">=</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> f <span class="op">=</span> fa<span class="op">[</span>o<span class="op">];</span> f <span class="op">=</span> fa<span class="op">[</span>o<span class="op">],</span> f <span class="op">!=</span> tgp<span class="op">;</span> rotate<span class="op">(</span>o<span class="op">)){</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            push<span class="op">(</span>f<span class="op">);</span> push<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>fa<span class="op">[</span>f<span class="op">]</span> <span class="op">!=</span> tgp<span class="op">)</span> rotate<span class="op">(</span>get<span class="op">(</span>o<span class="op">)</span> <span class="op">==</span> get<span class="op">(</span>f<span class="op">)</span> <span class="op">?</span> f <span class="op">:</span> o<span class="op">);</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>tgp<span class="op">)</span> rt <span class="op">=</span> o<span class="op">;</span> <span class="co">// changed `rt = tgp`  to `rt = o`.</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> build_sub<span class="op">(</span><span class="dt">int</span> <span class="op">&amp;</span>o<span class="op">,</span> <span class="dt">int</span> f<span class="op">,</span> <span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>A<span class="op">){</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>L <span class="op">&gt;</span> R<span class="op">)</span> <span class="cf">return</span> <span class="op">;</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> mid <span class="op">=</span> <span class="op">(</span>L <span class="op">+</span> R<span class="op">)</span> <span class="op">&gt;&gt;</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> make<span class="op">();</span> fa<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> f<span class="op">;</span> val<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> A<span class="op">[</span>mid<span class="op">];</span> v<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dt">data_t</span><span class="op">(</span>A<span class="op">[</span>mid<span class="op">]);</span> si<span class="op">[</span>o<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>L <span class="op">==</span> R<span class="op">)</span> <span class="cf">return</span> <span class="op">;</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>L <span class="op">&lt;=</span> mid <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> build_sub<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> o<span class="op">,</span> L<span class="op">,</span> mid <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> A<span class="op">);</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>mid <span class="op">+</span> <span class="dv">1</span> <span class="op">&lt;=</span> R<span class="op">)</span> build_sub<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> o<span class="op">,</span> mid <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> R<span class="op">,</span> A<span class="op">);</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        maintain<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> build<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>A<span class="op">){</span> </span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        build_sub<span class="op">(</span>rt<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> L<span class="op">,</span> R<span class="op">,</span> A<span class="op">);</span> </span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> insert<span class="op">(</span><span class="dt">int</span> <span class="op">&amp;</span>o<span class="op">,</span> <span class="dt">int</span> f<span class="op">,</span> <span class="dt">int</span> target<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>A<span class="op">,</span> <span class="dt">int</span> len<span class="op">){</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> build_sub<span class="op">(</span>o<span class="op">,</span> f<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> len<span class="op">,</span> A<span class="op">),</span> o<span class="op">;</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> r <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> push<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>target <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)])</span> r <span class="op">=</span> insert<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> o<span class="op">,</span> target<span class="op">,</span> A<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> r <span class="op">=</span> insert<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> o<span class="op">,</span> target <span class="op">-</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> A<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        maintain<span class="op">(</span>o<span class="op">);</span> <span class="cf">return</span> r<span class="op">;</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="dt">void</span> insert<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>A<span class="op">,</span> <span class="dt">int</span> pos<span class="op">,</span> <span class="dt">int</span> len<span class="op">)</span> <span class="op">{</span> <span class="dt">int</span> r <span class="op">=</span> insert<span class="op">(</span>rt<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> pos<span class="op">,</span> A<span class="op">,</span> len<span class="op">);</span> splay<span class="op">(</span>r<span class="op">);</span> <span class="op">}</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> find<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> k<span class="op">){</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>        push<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>k <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)])</span> <span class="cf">return</span> find<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> k<span class="op">);</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>k <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> o<span class="op">;</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">return</span> find<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> k <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]);</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> Make_Range<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">){</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> per <span class="op">=</span> find<span class="op">(</span>rt<span class="op">,</span> L <span class="op">-</span> <span class="dv">1</span><span class="op">),</span> suf <span class="op">=</span> find<span class="op">(</span>rt<span class="op">,</span> R <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>        splay<span class="op">(</span>per<span class="op">);</span> splay<span class="op">(</span>suf<span class="op">,</span> rt<span class="op">);</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> erase<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">){</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>        Make_Range<span class="op">(</span>L<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> <span class="op">&amp;</span> target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>        recycle<span class="op">(</span>target<span class="op">);</span> target <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> maintain<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> maintain<span class="op">(</span>rt<span class="op">);</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> rev<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">){</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>        Make_Range<span class="op">(</span>L<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> <span class="op">&amp;</span> target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>        tar_rev<span class="op">(</span>target<span class="op">);</span> maintain<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> maintain<span class="op">(</span>rt<span class="op">);</span></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> ret<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">,</span> <span class="dt">int</span> V<span class="op">){</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>        Make_Range<span class="op">(</span>L<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> <span class="op">&amp;</span> target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>        tar_ret<span class="op">(</span>target<span class="op">,</span> V<span class="op">);</span> maintain<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span> maintain<span class="op">(</span>rt<span class="op">);</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> query_sum<span class="op">(</span><span class="dt">int</span> L<span class="op">,</span> <span class="dt">int</span> R<span class="op">){</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>        Make_Range<span class="op">(</span>L<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> <span class="op">&amp;</span> target <span class="op">=</span> ls<span class="op">(</span>rs<span class="op">(</span>rt<span class="op">));</span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> v<span class="op">[</span>target<span class="op">].</span>sum<span class="op">;</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> query_ans<span class="op">(){</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> v<span class="op">[</span>rt<span class="op">].</span>ans<span class="op">;</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>   <span class="dt">void</span> dfs<span class="op">(</span><span class="dt">int</span> o <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">int</span> indent <span class="op">=</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>o <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> o <span class="op">=</span> rt<span class="op">;</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span>  <span class="op">{</span> cerr <span class="op">&lt;&lt;</span> string<span class="op">(</span>indent<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;# null&quot;</span> <span class="op">&lt;&lt;</span> endl<span class="op">;</span> <span class="cf">return</span> <span class="op">;</span> <span class="op">}</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>rs<span class="op">(</span>o<span class="op">))</span> <span class="ot">assert</span><span class="op">(</span>fa<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)]</span> <span class="op">==</span> o<span class="op">);</span> dfs<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> indent <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>    cerr <span class="op">&lt;&lt;</span> string<span class="op">(</span>indent<span class="op">,</span> <span class="ch">&#39; &#39;</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;# v=&quot;</span> <span class="op">&lt;&lt;</span> val<span class="op">[</span>o<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">&quot; ans=&quot;</span> <span class="op">&lt;&lt;</span> v<span class="op">[</span>o<span class="op">].</span>ans <span class="op">&lt;&lt;</span> endl<span class="op">;</span></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>ls<span class="op">(</span>o<span class="op">))</span> <span class="ot">assert</span><span class="op">(</span>fa<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">==</span> o<span class="op">);</span> dfs<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> indent <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a><span class="dt">Splay_t</span> t<span class="op">;</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> A<span class="op">[</span>_<span class="op">],</span> n<span class="op">,</span> m<span class="op">;</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> opt<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(){</span> <span class="co">//freopen(&quot;.in&quot;, &quot;r&quot;, stdin); freopen(&quot;.out&quot;, &quot;w&quot;, stdout);</span></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>    Read<span class="op">(</span>n<span class="op">)(</span>m<span class="op">);</span> n <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span> rep<span class="op">(</span>i<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> Read<span class="op">(</span>A<span class="op">[</span>i<span class="op">]);</span> </span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>    A<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> A<span class="op">[</span>n<span class="op">]</span> <span class="op">=</span> none<span class="op">;</span> <span class="co">// added line `A[1] = A[n] = -inf`. </span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>build<span class="op">(</span><span class="dv">1</span><span class="op">,</span> n<span class="op">,</span> A<span class="op">);</span></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>    rep<span class="op">(</span>tt<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> m<span class="op">){</span></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>        scanf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> opt<span class="op">);</span> <span class="dt">char</span> sign0 <span class="op">=</span> opt<span class="op">[</span><span class="dv">0</span><span class="op">],</span> sign1 <span class="op">=</span> opt<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>sign0 <span class="op">==</span> <span class="ch">&#39;I&#39;</span><span class="op">)</span> <span class="op">{</span> <span class="co">// Insert a sequence.</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> pos<span class="op">,</span> tot<span class="op">;</span> Read<span class="op">(</span>pos<span class="op">)(</span>tot<span class="op">);</span> rep<span class="op">(</span>i<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> tot<span class="op">)</span> Read<span class="op">(</span>A<span class="op">[</span>i<span class="op">]);</span> pos<span class="op">++;</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>            t<span class="op">.</span>insert<span class="op">(</span>A<span class="op">,</span> pos<span class="op">,</span> tot<span class="op">);</span></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sign0 <span class="op">==</span> <span class="ch">&#39;D&#39;</span><span class="op">){</span> <span class="co">// Delete a sequence.</span></span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> pos<span class="op">,</span> tot<span class="op">;</span> Read<span class="op">(</span>pos<span class="op">)(</span>tot<span class="op">);</span> pos<span class="op">++;</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>            t<span class="op">.</span>erase<span class="op">(</span>pos<span class="op">,</span> pos <span class="op">+</span> tot <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sign0 <span class="op">==</span> <span class="ch">&#39;R&#39;</span><span class="op">){</span> <span class="co">// Reverse a sequence.</span></span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> pos<span class="op">,</span> tot<span class="op">;</span> Read<span class="op">(</span>pos<span class="op">)(</span>tot<span class="op">);</span> pos<span class="op">++;</span></span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>            t<span class="op">.</span>rev<span class="op">(</span>pos<span class="op">,</span> tot <span class="op">+</span> pos <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sign0 <span class="op">==</span> <span class="ch">&#39;G&#39;</span><span class="op">){</span> <span class="co">// calc the sum of sequence.</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> pos<span class="op">,</span> tot<span class="op">;</span> Read<span class="op">(</span>pos<span class="op">)(</span>tot<span class="op">);</span> pos<span class="op">++;</span></span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> t<span class="op">.</span>query_sum<span class="op">(</span>pos<span class="op">,</span> pos <span class="op">+</span> tot <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>sign1 <span class="op">==</span> <span class="ch">&#39;-&#39;</span><span class="op">){</span> <span class="co">// calc the max sum sub sequence.</span></span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> t<span class="op">.</span>query_ans<span class="op">());</span></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">// make same on the sequence.</span></span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> pos<span class="op">,</span> tot<span class="op">,</span> c<span class="op">;</span> Read<span class="op">(</span>pos<span class="op">)(</span>tot<span class="op">)(</span>c<span class="op">);</span> pos<span class="op">++;</span></span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>            t<span class="op">.</span>ret<span class="op">(</span>pos<span class="op">,</span> pos <span class="op">+</span> tot <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> c<span class="op">);</span></span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="非旋-treap">非旋 Treap</h3>
<p>udp：2021/01/02. u1s1，这东西又短 又小 又快。<code>splay</code>
可能真的只有 <code>LCT</code> 里面才出场了。</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> rand<span class="op">(){</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">int</span> seed <span class="op">=</span> <span class="dv">1020031005</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> seed <span class="op">=</span> <span class="op">((</span>seed <span class="op">+</span><span class="dv">0</span><span class="bu">ll</span><span class="op">+</span> <span class="dv">20031006</span><span class="op">)</span> <span class="op">%</span> <span class="dv">998244353</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> FHQ<span class="op">{</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> _ <span class="op">=</span> <span class="fl">1e5</span> <span class="op">+</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ch<span class="op">[</span>_<span class="op">][</span><span class="dv">2</span><span class="op">],</span> si<span class="op">[</span>_<span class="op">],</span> v<span class="op">[</span>_<span class="op">],</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> rt <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define ls</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">0</span><span class="op">])</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define rs</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span>ch<span class="op">[</span>o<span class="op">][</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define maintain</span><span class="op">(</span>o<span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="dt">void</span><span class="op">)(</span>si<span class="op">[</span>o<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>si<span class="op">[</span>rs<span class="op">(</span>o<span class="op">)]</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define make</span><span class="op">(</span>vs<span class="op">)</span><span class="pp"> </span><span class="op">(++</span>tot<span class="op">,</span><span class="pp"> </span>v<span class="op">[</span>tot<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>vs<span class="op">,</span><span class="pp"> </span>si<span class="op">[</span>tot<span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="dv">1</span><span class="op">,</span><span class="pp"> </span>ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">0</span><span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span>ch<span class="op">[</span>tot<span class="op">][</span><span class="dv">1</span><span class="op">]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="dv">0</span><span class="op">,</span><span class="pp"> </span>tot<span class="op">)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#define mg</span><span class="op">(</span>a<span class="op">,</span><span class="pp"> </span>b<span class="op">,</span><span class="pp"> </span>c<span class="op">)</span><span class="pp"> </span><span class="op">(</span>merge<span class="op">(</span>merge<span class="op">(</span>a<span class="op">,</span><span class="pp"> </span>b<span class="op">),</span><span class="pp"> </span>c<span class="op">))</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> split<span class="op">(</span><span class="dt">int</span> o<span class="op">,</span> <span class="dt">int</span> V<span class="op">,</span> <span class="dt">int</span> <span class="op">&amp;</span>x<span class="op">,</span> <span class="dt">int</span> <span class="op">&amp;</span>y<span class="op">){</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>o<span class="op">)</span> <span class="cf">return</span> <span class="op">(</span><span class="dt">void</span><span class="op">)(</span>x <span class="op">=</span> y <span class="op">=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>v<span class="op">[</span>o<span class="op">]</span> <span class="op">&lt;=</span> V<span class="op">)</span> <span class="cf">return</span> x <span class="op">=</span> o<span class="op">,</span> split<span class="op">(</span>rs<span class="op">(</span>o<span class="op">),</span> V<span class="op">,</span> rs<span class="op">(</span>o<span class="op">),</span> y<span class="op">),</span> maintain<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y <span class="op">=</span> o<span class="op">,</span> split<span class="op">(</span>ls<span class="op">(</span>o<span class="op">),</span> V<span class="op">,</span> x<span class="op">,</span> ls<span class="op">(</span>o<span class="op">)),</span> maintain<span class="op">(</span>o<span class="op">);</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> merge<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">){</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> y <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> x <span class="op">+</span> y<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>rand<span class="op">()</span> <span class="op">%</span> <span class="op">(</span>si<span class="op">[</span>x<span class="op">]</span> <span class="op">+</span> si<span class="op">[</span>y<span class="op">])</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">&lt;=</span> si<span class="op">[</span>x<span class="op">])</span> <span class="cf">return</span> rs<span class="op">(</span>x<span class="op">)</span> <span class="op">=</span> merge<span class="op">(</span>rs<span class="op">(</span>x<span class="op">),</span> y<span class="op">),</span> maintain<span class="op">(</span>x<span class="op">),</span> x<span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">return</span> ls<span class="op">(</span>y<span class="op">)</span> <span class="op">=</span> merge<span class="op">(</span>x<span class="op">,</span> ls<span class="op">(</span>y<span class="op">)),</span> maintain<span class="op">(</span>y<span class="op">),</span> y<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> ins<span class="op">(</span><span class="dt">int</span> x<span class="op">){</span> <span class="dt">int</span> t0<span class="op">,</span> t1 <span class="op">=</span> make<span class="op">(</span>x<span class="op">),</span> t2<span class="op">;</span> split<span class="op">(</span>rt<span class="op">,</span> x<span class="op">,</span> t0<span class="op">,</span> t2<span class="op">);</span> rt <span class="op">=</span> mg<span class="op">(</span>t0<span class="op">,</span> t1<span class="op">,</span> t2<span class="op">);</span> <span class="op">}</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> erase<span class="op">(</span><span class="dt">int</span> V<span class="op">){</span> <span class="dt">int</span> x<span class="op">,</span> y<span class="op">,</span> z<span class="op">;</span> split<span class="op">(</span>rt<span class="op">,</span> V<span class="op">,</span> y<span class="op">,</span> z<span class="op">);</span> split<span class="op">(</span>y<span class="op">,</span> V <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> x<span class="op">,</span> y<span class="op">);</span> y <span class="op">=</span> merge<span class="op">(</span>ls<span class="op">(</span>y<span class="op">),</span> rs<span class="op">(</span>y<span class="op">));</span> rt <span class="op">=</span> mg<span class="op">(</span>x<span class="op">,</span> y<span class="op">,</span> z<span class="op">);</span> <span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> rank<span class="op">(</span><span class="dt">int</span> V<span class="op">)</span> <span class="op">{</span> <span class="dt">int</span> x<span class="op">,</span> y<span class="op">;</span> split<span class="op">(</span>rt<span class="op">,</span> V <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> x<span class="op">,</span> y<span class="op">);</span> <span class="dt">int</span> res <span class="op">=</span> si<span class="op">[</span>x<span class="op">];</span> rt <span class="op">=</span> merge<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span> <span class="cf">return</span> res <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> select<span class="op">(</span><span class="dt">int</span> V<span class="op">,</span> <span class="dt">int</span> o <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">){</span> <span class="cf">if</span><span class="op">(</span>o <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> o <span class="op">=</span> rt<span class="op">;</span> <span class="cf">if</span><span class="op">(</span>V <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)])</span> <span class="cf">return</span> select<span class="op">(</span>V<span class="op">,</span> ls<span class="op">(</span>o<span class="op">));</span> <span class="cf">else</span> <span class="op">{</span> <span class="cf">if</span><span class="op">(</span>V <span class="op">&lt;=</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> v<span class="op">[</span>o<span class="op">];</span> <span class="cf">else</span> <span class="cf">return</span> select<span class="op">(</span>V <span class="op">-</span> si<span class="op">[</span>ls<span class="op">(</span>o<span class="op">)]</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> rs<span class="op">(</span>o<span class="op">));</span> <span class="op">}</span> <span class="op">}</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pred<span class="op">(</span><span class="dt">int</span> V<span class="op">){</span> <span class="dt">int</span> x<span class="op">,</span> y<span class="op">;</span> split<span class="op">(</span>rt<span class="op">,</span> V <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> x<span class="op">,</span> y<span class="op">);</span> <span class="dt">int</span> res <span class="op">=</span> select<span class="op">(</span>si<span class="op">[</span>x<span class="op">],</span> x<span class="op">);</span> rt <span class="op">=</span> merge<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span> <span class="cf">return</span> res<span class="op">;</span> <span class="op">}</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> succ<span class="op">(</span><span class="dt">int</span> V<span class="op">){</span> <span class="dt">int</span> x<span class="op">,</span> y<span class="op">;</span> split<span class="op">(</span>rt<span class="op">,</span> V<span class="op">,</span> x<span class="op">,</span> y<span class="op">);</span> <span class="dt">int</span> res <span class="op">=</span> select<span class="op">(</span><span class="dv">1</span><span class="op">,</span> y<span class="op">);</span> rt <span class="op">=</span> merge<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span> <span class="cf">return</span> res<span class="op">;</span> <span class="op">}</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="kw">using</span> FHQ<span class="op">::</span> ins <span class="op">;</span><span class="kw">using</span> FHQ<span class="op">::</span> erase <span class="op">;</span><span class="kw">using</span> FHQ<span class="op">::</span> select <span class="op">;</span><span class="kw">using</span> FHQ<span class="op">::</span> rank <span class="op">;</span><span class="kw">using</span> FHQ<span class="op">::</span> pred <span class="op">;</span><span class="kw">using</span> FHQ<span class="op">::</span> succ <span class="op">;</span></span></code></pre></div>
                                    </div>

                                    <!-- Article Footer -->
                                    <div class="article-footer">
                                                                            
                                        <section class="post-history">
                                            <div class="history-header">
                                                <h2>📚 Version History</h2>
                                                <span class="history-desc">Source Code Change History</span>
                                            </div>
                                            <div class="version-list">
                                                
                                                    <div class="version-item">
                                                        <div class="version-header">
                                                            <span class="version-badge">v1</span>
                                                            <time class="version-time" datetime="2020-12-20 21:34:36">
                                                                📅 2020-12-20 21:34:36
                                                            </time>
                                                        </div>
                                                        <div class="version-hash-container">
                                                            <span class="hash-label">🔗 Source Hash:</span>
                                                            <code class="version-hash" title="Source Code Hash (3f983f205f9165e3106268572e9af37c3b96c83293476ec503dd6a7fc186062b)">3f983f205f9165e3106268572e9af37c3b96c83293476ec503dd6a7fc186062b</code>
                                                        </div>
                                                    </div>
                                                
                                            </div>
                                        </section>
                    

                    
                                            <details class="build-logs">
                                                <summary>Build Logs</summary>
                                                <pre class="logs-content">Build Log - Filtered
================================================

📋 Information:
• Path information has been filtered for privacy protection
• File names are preserved for debugging purposes  
• All build status and error messages are kept intact

🔍 Filter Rules:
• /absolute/path/file.ext → .../file.ext
• /home/username → .../[user]
• /tmp/files → .../[temp]
• /usr/share/packages → .../[system]

================================================

html log:
CMD: ['pandoc', '-s', 'cache/oi-blog_「学习总结」数据结构.md', '--filter', 'pandoc-crossref', '--filter', 'pandoc-katex', '--template=cache/pandoc_html_template.html', '-o', 'cache.../oi-blog_「学习总结」数据结构.md.html', '--metadata', '--verbose', '--highlight-style=tango']
STDOUT: 
STDERR: WARNING: pandoc-crossref was compiled with pandoc 3.6.2 but is being run through 3.6.4. This is not supported. Strange things may (and likely will) happen silently.

====================================================================================================
pdf log:
CMD: ['pandoc', '-s', 'cache.../d7b80b92ac.pdf.md', '-o', 'cache/d7b80b92ac.pdf', '-H', 'static/pandoc.header.tex', '--pdf-engine=xelatex', '--verbose']
STDOUT: 
STDERR: [INFO] Loaded static.../pandoc.header.tex from static.../pandoc.header.tex
[INFO] Not rendering RawBlock (Format "html") "<!-- more -->"
[INFO] Not rendering RawInline (Format "html") "<!-- more -->"
[INFO] [makePDF] Temp dir:
  .../[temp]
[INFO] [makePDF] Command line:
  xelatex "-halt-on-error" "-interaction" "nonstopmode" "-output-directory" ".../[temp] ".../[temp]
[INFO] [makePDF] Relevant environment variables:
  ("TEXINPUTS",".../[temp]
  ("TEXMFOUTPUT",".../[temp]
  ("SHELL","/bin/bash")
  ("PWD",".../[user]/projects/blog")
  ("HOME",".../[user]
  ("LANG","zh_CN.UTF-8")
  ("PATH",".../[user]/.local/bin:.../[user]/.cargo/bin:.../[user]/miniconda3/envs/myblog/bin:.../[user]/miniconda3/condabin:.../[temp]
[INFO] [makePDF] Source:
  % Options for packages loaded elsewhere
  \PassOptionsToPackage{unicode}{hyperref}
  \PassOptionsToPackage{hyphens}{url}
  \PassOptionsToPackage{space}{xeCJK}
  \documentclass[
  ]{article}
  \usepackage{xcolor}
  \usepackage[a4paper,margin=2cm]{geometry}
  \usepackage{amsmath,amssymb}
  \setcounter{secnumdepth}{-\maxdimen} % remove section numbering
  \usepackage{iftex}
  \ifPDFTeX
    \usepackage[T1]{fontenc}
    \usepackage[utf8]{inputenc}
    \usepackage{textcomp} % provide euro and other symbols
  \else % if luatex or xetex
    \usepackage{unicode-math} % this also loads fontspec
    \defaultfontfeatures{Scale=MatchLowercase}
    \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
  \fi
  \usepackage{lmodern}
  \ifPDFTeX\else
    % xetex/luatex font selection
    \setmainfont[]{Latin Modern Roman}
    \ifXeTeX
      \usepackage{xeCJK}
      \setCJKmainfont[]{AR PL UKai CN}
    \fi
    \ifLuaTeX
      \usepackage[]{luatexja-fontspec}
      \setmainjfont[]{AR PL UKai CN}
    \fi
  \fi
  % Use upquote if available, for straight quotes in verbatim environments
  \IfFileExists{upquote.sty}{\usepackage{upquote}}{}
  \IfFileExists{microtype.sty}{% use microtype if available
    \usepackage[]{microtype}
    \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
  }{}
  \usepackage{setspace}
  \makeatletter
  \@ifundefined{KOMAClassName}{% if non-KOMA class
    \IfFileExists{parskip.sty}{%
      \usepackage{parskip}
    }{% else
      \setlength{\parindent}{0pt}
      \setlength{\parskip}{6pt plus 2pt minus 1pt}}
  }{% if KOMA class
    \KOMAoptions{parskip=half}}
  \makeatother
  \usepackage{color}
  \usepackage{fancyvrb}
  \newcommand{\VerbBar}{|}
  \newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
  % Add ',fontsize=\small' for more characters per line
  \newenvironment{Shaded}{}{}
  \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{#1}}}
  \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{#1}}}}
  \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{#1}}
  \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{#1}}
  \newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.50,0.00}{#1}}
  \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{#1}}
  \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{#1}}}
  \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{#1}}}}
  \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{#1}}
  \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{#1}}}
  \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{#1}}
  \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{#1}}
  \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{#1}}}
  \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{#1}}}
  \newcommand{\ExtensionTok}[1]{#1}
  \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{#1}}
  \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{#1}}
  \newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.50,0.00}{\textbf{#1}}}
  \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{#1}}}}
  \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{#1}}}
  \newcommand{\NormalTok}[1]{#1}
  \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
  \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{#1}}
  \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{#1}}
  \newcommand{\RegionMarkerTok}[1]{#1}
  \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{#1}}
  \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{#1}}
  \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{#1}}
  \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{#1}}
  \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{#1}}
  \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{#1}}}}
  \ifLuaTeX
    \usepackage{luacolor}
    \usepackage[soul]{lua-ul}
  \else
    \usepackage{soul}
    \ifXeTeX
      % soul's \st doesn't work for CJK:
      \usepackage{xeCJKfntef}
      \renewcommand{\st}[1]{\sout{#1}}
    \fi
  \fi
  \setlength{\emergencystretch}{3em} % prevent overfull lines
  \providecommand{\tightlist}{%
    \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
  % \usepackage{xeCJK}
  % \setCJKmainfont{AR PL UKai CN}
  % \usepackage{unicode-math}
  
  \setmathfont{Latin Modern Math}
  \usepackage{bookmark}
  \IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
  \urlstyle{same}
  \hypersetup{
    pdftitle={「学习总结」数据结构},
    pdfauthor={Jiayi Su (ShuYuMo)},
    hidelinks,
    pdfcreator={LaTeX via pandoc}}
  
  \title{「学习总结」数据结构}
  \author{Jiayi Su (ShuYuMo)}
  \date{2020-12-20 21:34:36}
  
  \begin{document}
  \maketitle
  
  \setstretch{1.3}
  \st{真的好爱 \mbox{\texttt{Splay}}!}
  
  好像只有 \texttt{LCT} 中才有必要写 \texttt{Splay} 吧…… 其实
  \texttt{非旋\ Treap} 真的是又短，有小，又快……
  
  \section{数据结构}\label{ux6570ux636eux7ed3ux6784}
  
  \subsection{平衡树}\label{ux5e73ux8861ux6811}
  
  \subsubsection{Splay}\label{splay}
  
  \begin{itemize}
  \tightlist
  \item
    删除结点时，不是 \texttt{Splay}
    到根然后合并两边的子树，而是将待删除的结点前驱 \texttt{Splay}
    到根节点， 后继 \texttt{Splay} 到根节点右儿子，那么待删除的结点就在
    \texttt{ls(rs(rt))}
    上。这样可以删除集合内一个区间的元素，也方便后面维护序列。
  \end{itemize}
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \DataTypeTok{void}\NormalTok{ erase}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)\{}
  \NormalTok{    PII pre }\OperatorTok{=}\NormalTok{ \_pred}\OperatorTok{(}\NormalTok{v}\OperatorTok{),}\NormalTok{ nxt }\OperatorTok{=}\NormalTok{ \_nxtd}\OperatorTok{(}\NormalTok{v}\OperatorTok{);}
  \NormalTok{    splay}\OperatorTok{(}\NormalTok{pre}\OperatorTok{.}\NormalTok{se}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{nxt}\OperatorTok{.}\NormalTok{se}\OperatorTok{,}\NormalTok{ rt}\OperatorTok{);}
      \DataTypeTok{int} \OperatorTok{\&}\NormalTok{target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{target}\OperatorTok{]} \OperatorTok{{-}{-};}\NormalTok{ si}\OperatorTok{[}\NormalTok{target}\OperatorTok{]{-}{-};}
      \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{cnt}\OperatorTok{[}\NormalTok{target}\OperatorTok{])}\NormalTok{ target }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{    maintain}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{  maintain}\OperatorTok{(}\NormalTok{rt}\OperatorTok{);}
  \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \begin{itemize}
  \tightlist
  \item
    如果空间要求较严格，可以考虑手写一个小的内存管理函数，删除时回收内存，新增元素时优先使用之前删除的结点内存。
  \end{itemize}
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \NormalTok{stack}\OperatorTok{\textless{}}\DataTypeTok{int}\OperatorTok{\textgreater{}}\NormalTok{ Mem}\OperatorTok{;}
  \DataTypeTok{int}\NormalTok{ make}\OperatorTok{()\{}
      \DataTypeTok{int}\NormalTok{ t}\OperatorTok{;} \DataTypeTok{int}\NormalTok{ o }\OperatorTok{=} \OperatorTok{(}\NormalTok{Mem}\OperatorTok{.}\NormalTok{empty}\OperatorTok{()} \OperatorTok{?} \OperatorTok{++}\NormalTok{tot }\OperatorTok{:} \OperatorTok{(}\NormalTok{t }\OperatorTok{=}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{top}\OperatorTok{(),}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{pop}\OperatorTok{(),}\NormalTok{ t}\OperatorTok{));} 
  \NormalTok{    ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{0}\OperatorTok{]} \OperatorTok{=}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{    si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DecValTok{1}\OperatorTok{;}
      \ControlFlowTok{return}\NormalTok{ o}\OperatorTok{;}
  \OperatorTok{\}}
  \DataTypeTok{void}\NormalTok{ recycle}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)} \OperatorTok{\{} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{o }\OperatorTok{==} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)}\NormalTok{ o }\OperatorTok{=}\NormalTok{ rt}\OperatorTok{;} \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{;}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}\NormalTok{ recycle}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{));}\NormalTok{ recycle}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{));} \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \begin{itemize}
  \tightlist
  \item
    如果需要开多棵 \texttt{Splay}，可以考虑只封装每棵 \texttt{Splay}
    的根节点，对于结点内存的申请和释放统一管理
  \item
    一个很方便的调试 \texttt{Splay} 的函数：
  \end{itemize}
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \DataTypeTok{void}\NormalTok{ dfs}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ indent }\OperatorTok{=} \DecValTok{0}\OperatorTok{)\{}
      \ControlFlowTok{if}\OperatorTok{(}\NormalTok{o }\OperatorTok{==} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)}\NormalTok{ o }\OperatorTok{=}\NormalTok{ rt}\OperatorTok{;}
      \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)}  \OperatorTok{\{}\NormalTok{ cerr }\OperatorTok{\textless{}\textless{}}\NormalTok{ string}\OperatorTok{(}\NormalTok{indent}\OperatorTok{,} \CharTok{\textquotesingle{} \textquotesingle{}}\OperatorTok{)} \OperatorTok{\textless{}\textless{}} \StringTok{"\# null"} \OperatorTok{\textless{}\textless{}}\NormalTok{ endl}\OperatorTok{;} \ControlFlowTok{return} \OperatorTok{;} \OperatorTok{\}}
  \NormalTok{    push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \OtherTok{assert}\OperatorTok{(!}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)} \OperatorTok{||}\NormalTok{ fa}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{==}\NormalTok{ o}\OperatorTok{);}\NormalTok{ dfs}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ indent }\OperatorTok{+} \DecValTok{10}\OperatorTok{);}
  \NormalTok{    cerr }\OperatorTok{\textless{}\textless{}}\NormalTok{ string}\OperatorTok{(}\NormalTok{indent}\OperatorTok{,} \CharTok{\textquotesingle{} \textquotesingle{}}\OperatorTok{)} \OperatorTok{\textless{}\textless{}} \StringTok{"\# v="} \OperatorTok{\textless{}\textless{}}\NormalTok{ val}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{\textless{}\textless{}} \StringTok{" ans="} \OperatorTok{\textless{}\textless{}}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{].}\NormalTok{ans }\OperatorTok{\textless{}\textless{}}\NormalTok{ endl}\OperatorTok{;}
      \OtherTok{assert}\OperatorTok{(!}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)} \OperatorTok{||}\NormalTok{ fa}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{==}\NormalTok{ o}\OperatorTok{);}\NormalTok{ dfs}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ indent }\OperatorTok{+} \DecValTok{10}\OperatorTok{);}
  \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \begin{itemize}
  \tightlist
  \item
    建立哨兵结点作为整个 \texttt{Splay}
    的最小最大值是一个通用技巧，删除操作依赖于前驱和后继结点，所以哨兵结点时必要的。维护序列时注意消除哨兵结点对答案的影响。
  \end{itemize}
  
  \paragraph{维护集合}\label{ux7ef4ux62a4ux96c6ux5408}
  
  一种动态维护集合元素，查询集合元素信息的解决方案。 -
  为了优化常数和简化代码，查询前驱后继不再采用 \texttt{插入-删除}
  式查询。查询元素排名之后直接选取前驱和后继即可。
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \NormalTok{PII \_pred}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)\{}
  \NormalTok{    PII res }\OperatorTok{=}\NormalTok{ rank}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ v}\OperatorTok{);}
      \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{);}
  \OperatorTok{\}} \DataTypeTok{int}\NormalTok{ pred}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ PII res }\OperatorTok{=}\NormalTok{ \_pred}\OperatorTok{(}\NormalTok{v}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi}\OperatorTok{;} \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \begin{itemize}
  \tightlist
  \item
    \texttt{rank} 和 \texttt{select} 返回值为
    \texttt{pair\textless{}int,\ int\textgreater{}}
    其中，前一个指答案，后一个是作用结点，方便后期获取结点信息（\texttt{Splay}）。
    \texttt{int\ rank(int\ v)\ \{\ PII\ res\ =\ rank(rt,\ v);\ if(res.se)\ splay(res.se);\ return\ res.fi\ -\ 1;\ \}}
  \end{itemize}
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \KeywordTok{struct} \DataTypeTok{Splay\_t}\OperatorTok{\{}
      \DataTypeTok{int}\NormalTok{ ch}\OperatorTok{[}\NormalTok{\_}\OperatorTok{][}\DecValTok{2}\OperatorTok{],}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ si}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ v}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ fa}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ tot}\OperatorTok{,}\NormalTok{ rt}\OperatorTok{;}
      \KeywordTok{typedef}\NormalTok{ pair}\OperatorTok{\textless{}}\DataTypeTok{int}\OperatorTok{,} \DataTypeTok{int}\OperatorTok{\textgreater{}}\NormalTok{ PII}\OperatorTok{;}
      \PreprocessorTok{\#define ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{0}\OperatorTok{])}
      \PreprocessorTok{\#define rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{1}\OperatorTok{])}
      \PreprocessorTok{\#define maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\NormalTok{cnt}\OperatorTok{[}\NormalTok{o}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])}
      \PreprocessorTok{\#define get}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{o}\PreprocessorTok{ }\OperatorTok{==}\PreprocessorTok{ }\NormalTok{ch}\OperatorTok{[}\NormalTok{fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]][}\DecValTok{1}\OperatorTok{])}
      \DataTypeTok{int}\NormalTok{ make}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ f}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{}
  \NormalTok{        tot}\OperatorTok{++;}
  \NormalTok{        ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{0}\OperatorTok{]} \OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{        si}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=} \DecValTok{1}\OperatorTok{;}
  \NormalTok{        fa}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ f}\OperatorTok{;}\NormalTok{ v}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ V}\OperatorTok{;}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{f}\OperatorTok{)}\NormalTok{ ch}\OperatorTok{[}\NormalTok{f}\OperatorTok{][}\NormalTok{v}\OperatorTok{[}\NormalTok{f}\OperatorTok{]} \OperatorTok{\textless{}}\NormalTok{ V}\OperatorTok{]} \OperatorTok{=}\NormalTok{ tot}\OperatorTok{;}
          \ControlFlowTok{return}\NormalTok{ tot}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ rotate}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{)\{}
          \DataTypeTok{int}\NormalTok{ p }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{],}\NormalTok{ gp }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]],}\NormalTok{ chk }\OperatorTok{=}\NormalTok{ get}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
  \NormalTok{        ch}\OperatorTok{[}\NormalTok{p}\OperatorTok{][}\NormalTok{chk}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk}\OperatorTok{\^{}}\DecValTok{1}\OperatorTok{];}\NormalTok{ fa}\OperatorTok{[}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk}\OperatorTok{\^{}}\DecValTok{1}\OperatorTok{]]} \OperatorTok{=}\NormalTok{ p}\OperatorTok{;}
  \NormalTok{        ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk}\OperatorTok{\^{}}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ p}\OperatorTok{;}\NormalTok{ fa}\OperatorTok{[}\NormalTok{p}\OperatorTok{]} \OperatorTok{=}\NormalTok{ o}\OperatorTok{;}
  \NormalTok{        fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ gp}\OperatorTok{;} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{gp}\OperatorTok{)}\NormalTok{ ch}\OperatorTok{[}\NormalTok{gp}\OperatorTok{][}\NormalTok{ch}\OperatorTok{[}\NormalTok{gp}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{==}\NormalTok{ p}\OperatorTok{]} \OperatorTok{=}\NormalTok{ o}\OperatorTok{;}
  \NormalTok{        maintain}\OperatorTok{(}\NormalTok{p}\OperatorTok{);}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ splay}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ tgp }\OperatorTok{=} \DecValTok{0}\OperatorTok{)\{}
          \ControlFlowTok{for}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ f }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{];}\NormalTok{ f }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{],}\NormalTok{ f }\OperatorTok{!=}\NormalTok{ tgp}\OperatorTok{;}\NormalTok{ rotate}\OperatorTok{(}\NormalTok{o}\OperatorTok{))} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{fa}\OperatorTok{[}\NormalTok{f}\OperatorTok{]} \OperatorTok{!=}\NormalTok{ tgp}\OperatorTok{)}\NormalTok{ rotate}\OperatorTok{(}\NormalTok{get}\OperatorTok{(}\NormalTok{o}\OperatorTok{)} \OperatorTok{==}\NormalTok{ get}\OperatorTok{(}\NormalTok{f}\OperatorTok{)} \OperatorTok{?}\NormalTok{ f }\OperatorTok{:}\NormalTok{ o}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{tgp}\OperatorTok{)}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ o}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ ins}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ f}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ make}\OperatorTok{(}\NormalTok{f}\OperatorTok{,}\NormalTok{ V}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{==}\NormalTok{ V}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{(}\NormalTok{cnt}\OperatorTok{[}\NormalTok{o}\OperatorTok{]++,}\NormalTok{ si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]++,}\NormalTok{ o}\OperatorTok{);}
          \DataTypeTok{int}\NormalTok{ r}\OperatorTok{;} \ControlFlowTok{return} \OperatorTok{(}\NormalTok{r }\OperatorTok{=}\NormalTok{ ins}\OperatorTok{(}\NormalTok{V }\OperatorTok{\textless{}}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{?}\NormalTok{ ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)} \OperatorTok{:}\NormalTok{ rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ o}\OperatorTok{,}\NormalTok{ V}\OperatorTok{),}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ r}\OperatorTok{);}
      \OperatorTok{\}} \DataTypeTok{void}\NormalTok{ ins}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)} \OperatorTok{\{} \DataTypeTok{int}\NormalTok{ t }\OperatorTok{=}\NormalTok{ ins}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,} \DecValTok{0}\OperatorTok{,}\NormalTok{ v}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{t}\OperatorTok{);} \OperatorTok{\}}
      
  \NormalTok{    PII rank}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ mp}\OperatorTok{(}\DecValTok{1}\OperatorTok{,} \DecValTok{0}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{V }\OperatorTok{==}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{])} \ControlFlowTok{return}\NormalTok{ mp}\OperatorTok{(}\NormalTok{si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{+} \DecValTok{1}\OperatorTok{,}\NormalTok{ o}\OperatorTok{);}
  \NormalTok{        PII res}\OperatorTok{;} 
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{V }\OperatorTok{\textless{}}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{])} \ControlFlowTok{return}\NormalTok{ rank}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ V}\OperatorTok{);} 
          \ControlFlowTok{else} \ControlFlowTok{return} \OperatorTok{(}\NormalTok{res }\OperatorTok{=}\NormalTok{ rank}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ V}\OperatorTok{),}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi }\OperatorTok{+=}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{+}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)],}\NormalTok{ res}\OperatorTok{);}
      \OperatorTok{\}} \DataTypeTok{int}\NormalTok{ rank}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ PII res }\OperatorTok{=}\NormalTok{ rank}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ v}\OperatorTok{);} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{)}\NormalTok{ splay}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{;} \OperatorTok{\}}
      
  \NormalTok{    PII select}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ k}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{k }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])} \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ k}\OperatorTok{);}
          \ControlFlowTok{else} \OperatorTok{\{}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{k }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{+}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{o}\OperatorTok{])} \ControlFlowTok{return}\NormalTok{ mp}\OperatorTok{(}\NormalTok{v}\OperatorTok{[}\NormalTok{o}\OperatorTok{],}\NormalTok{ o}\OperatorTok{);}
              \ControlFlowTok{else} \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ k }\OperatorTok{{-}}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{{-}}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]);}
          \OperatorTok{\}}
      \OperatorTok{\}} \DataTypeTok{int}\NormalTok{ select}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ k}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ PII res }\OperatorTok{=}\NormalTok{ select}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ k }\OperatorTok{+} \DecValTok{1}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi}\OperatorTok{;} \OperatorTok{\}}
      
  \NormalTok{    PII \_pred}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)\{}
  \NormalTok{        PII res }\OperatorTok{=}\NormalTok{ rank}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ v}\OperatorTok{);}
          \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{);}
      \OperatorTok{\}} \DataTypeTok{int}\NormalTok{ pred}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ PII res }\OperatorTok{=}\NormalTok{ \_pred}\OperatorTok{(}\NormalTok{v}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi}\OperatorTok{;} \OperatorTok{\}}
  
  \NormalTok{    PII \_nxtd}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)\{}
  \NormalTok{        PII res }\OperatorTok{=}\NormalTok{ rank}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ v}\OperatorTok{);}
          \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi }\OperatorTok{+}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{]);}
      \OperatorTok{\}} \DataTypeTok{int}\NormalTok{ nxtd}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ PII res }\OperatorTok{=}\NormalTok{ \_nxtd}\OperatorTok{(}\NormalTok{v}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{res}\OperatorTok{.}\NormalTok{se}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{.}\NormalTok{fi}\OperatorTok{;} \OperatorTok{\}}
      
      \DataTypeTok{void}\NormalTok{ erase}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{)\{}
  \NormalTok{        PII pre }\OperatorTok{=}\NormalTok{ \_pred}\OperatorTok{(}\NormalTok{v}\OperatorTok{),}\NormalTok{ nxt }\OperatorTok{=}\NormalTok{ \_nxtd}\OperatorTok{(}\NormalTok{v}\OperatorTok{);}
  \NormalTok{        splay}\OperatorTok{(}\NormalTok{pre}\OperatorTok{.}\NormalTok{se}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{nxt}\OperatorTok{.}\NormalTok{se}\OperatorTok{,}\NormalTok{ rt}\OperatorTok{);}
          \DataTypeTok{int} \OperatorTok{\&}\NormalTok{target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ cnt}\OperatorTok{[}\NormalTok{target}\OperatorTok{]} \OperatorTok{{-}{-};}\NormalTok{ si}\OperatorTok{[}\NormalTok{target}\OperatorTok{]{-}{-};}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{cnt}\OperatorTok{[}\NormalTok{target}\OperatorTok{])}\NormalTok{ target }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{        maintain}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{  maintain}\OperatorTok{(}\NormalTok{rt}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{Splay\_t}\OperatorTok{()\{}\NormalTok{ tot }\OperatorTok{=}\NormalTok{ rt }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}\NormalTok{ ins}\OperatorTok{(}\NormalTok{INT\_MAX}\OperatorTok{);}\NormalTok{ ins}\OperatorTok{(}\NormalTok{INT\_MIN}\OperatorTok{);} \OperatorTok{\}}
  \OperatorTok{\};}
  \end{Highlighting}
  \end{Shaded}
  
  \paragraph{维护序列}\label{ux7ef4ux62a4ux5e8fux5217}
  
  一种支持增删元素的，线段树替代方案。
  本质上和线段的思想很相似，一样采用信息合并和懒标记优化复杂度，每个结点也和线段树一样存储一个子区间的信息。
  唯一不同的就是线段树是一种
  \texttt{Leafy\ Tree}，即所有信息都只存储在叶子结点上，其结构导致无法删除和新增元素。
  -
  注意懒标记和线段树的定义是一样的，其作用节点的信息首先被修改。类比线段树的懒标记直接写就好了。
  -
  平衡树合并信息和线段树合并信息不同点在于：线段树是合并两边的信息，平衡树是先合并左子结点信息和中间结点信息再与有子结点合并，其实还是因为线段树是一种
  \texttt{Leafy\ Tree} —— 和平衡树有本质区别。 - 因为 \texttt{Splay}
  可以相对较好的控制树的形态，可以让一个子树组成任意区间，所以能够很好的维护序列。
  - 核心操作：
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \DataTypeTok{void}\NormalTok{ Make\_Range}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{)\{}
      \DataTypeTok{int}\NormalTok{ pre }\OperatorTok{=}\NormalTok{ find}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ L }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{),}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ find}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ R }\OperatorTok{+} \DecValTok{1}\OperatorTok{);}
  \NormalTok{    splay}\OperatorTok{(}\NormalTok{pre}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{suf}\OperatorTok{,}\NormalTok{ rt}\OperatorTok{);}
  \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \AttributeTok{const} \DataTypeTok{int}\NormalTok{ \_ }\OperatorTok{=} \FloatTok{5e5} \OperatorTok{+} \DecValTok{10}\OperatorTok{;}
  \KeywordTok{struct} \DataTypeTok{Splay\_t}\OperatorTok{\{}
  \NormalTok{    stack}\OperatorTok{\textless{}}\DataTypeTok{int}\OperatorTok{\textgreater{}}\NormalTok{ Mem}\OperatorTok{;}
      \PreprocessorTok{\#define none }\OperatorTok{({-}}\DecValTok{30000}\OperatorTok{)}
      \KeywordTok{struct} \DataTypeTok{data\_t}\OperatorTok{\{}
          \DataTypeTok{int}\NormalTok{ sum}\OperatorTok{,}\NormalTok{ per}\OperatorTok{,}\NormalTok{ suf}\OperatorTok{,}\NormalTok{ ans}\OperatorTok{;}
          \DataTypeTok{data\_t}\OperatorTok{()\{}\NormalTok{ per }\OperatorTok{=}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ ans }\OperatorTok{=} \OperatorTok{{-}}\FloatTok{1e9}\OperatorTok{;}\NormalTok{ sum }\OperatorTok{=} \DecValTok{0}\OperatorTok{;} \OperatorTok{\};}
          \DataTypeTok{data\_t}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{)} \OperatorTok{\{}\NormalTok{ sum }\OperatorTok{=}\NormalTok{ per }\OperatorTok{=}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ ans }\OperatorTok{=}\NormalTok{ V}\OperatorTok{;} \OperatorTok{\}}
          \DataTypeTok{void}\NormalTok{ ret}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ v}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ len}\OperatorTok{)\{}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{v }\OperatorTok{\textless{}=} \DecValTok{0}\OperatorTok{)}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ per }\OperatorTok{=}\NormalTok{ ans }\OperatorTok{=}\NormalTok{ v}\OperatorTok{,}\NormalTok{ sum }\OperatorTok{=}\NormalTok{ v }\OperatorTok{*}\NormalTok{ len}\OperatorTok{;} \CommentTok{// changed \textasciigrave{}sum = v\textasciigrave{} to \textasciigrave{}sum = v * len\textasciigrave{}.}
              \ControlFlowTok{else}\NormalTok{       sum }\OperatorTok{=}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ per }\OperatorTok{=}\NormalTok{ ans }\OperatorTok{=}\NormalTok{ v }\OperatorTok{*}\NormalTok{ len}\OperatorTok{;}
          \OperatorTok{\}}
          \DataTypeTok{void}\NormalTok{ rev}\OperatorTok{()} \OperatorTok{\{}\NormalTok{ swap}\OperatorTok{(}\NormalTok{per}\OperatorTok{,}\NormalTok{ suf}\OperatorTok{);} \OperatorTok{\}}
          \DataTypeTok{data\_t} \KeywordTok{operator} \OperatorTok{+} \OperatorTok{(}\AttributeTok{const} \DataTypeTok{data\_t} \OperatorTok{\&}\NormalTok{ B}\OperatorTok{)} \OperatorTok{\{}
              \DataTypeTok{data\_t}\NormalTok{ A }\OperatorTok{=} \OperatorTok{*}\KeywordTok{this}\OperatorTok{,}\NormalTok{ res}\OperatorTok{;}
  \NormalTok{            res}\OperatorTok{.}\NormalTok{sum }\OperatorTok{=}\NormalTok{ A}\OperatorTok{.}\NormalTok{sum }\OperatorTok{+}\NormalTok{ B}\OperatorTok{.}\NormalTok{sum}\OperatorTok{;}
  \NormalTok{            res}\OperatorTok{.}\NormalTok{per }\OperatorTok{=}\NormalTok{ max}\OperatorTok{(}\NormalTok{A}\OperatorTok{.}\NormalTok{per}\OperatorTok{,}\NormalTok{ A}\OperatorTok{.}\NormalTok{sum }\OperatorTok{+}\NormalTok{ B}\OperatorTok{.}\NormalTok{per}\OperatorTok{);}
  \NormalTok{            res}\OperatorTok{.}\NormalTok{suf }\OperatorTok{=}\NormalTok{ max}\OperatorTok{(}\NormalTok{A}\OperatorTok{.}\NormalTok{suf }\OperatorTok{+}\NormalTok{ B}\OperatorTok{.}\NormalTok{sum}\OperatorTok{,}\NormalTok{ B}\OperatorTok{.}\NormalTok{suf}\OperatorTok{);}
  \NormalTok{            res}\OperatorTok{.}\NormalTok{ans }\OperatorTok{=}\NormalTok{ max}\OperatorTok{(}\NormalTok{max}\OperatorTok{(}\NormalTok{A}\OperatorTok{.}\NormalTok{ans}\OperatorTok{,}\NormalTok{ B}\OperatorTok{.}\NormalTok{ans}\OperatorTok{),}\NormalTok{ A}\OperatorTok{.}\NormalTok{suf }\OperatorTok{+}\NormalTok{ B}\OperatorTok{.}\NormalTok{per}\OperatorTok{);}
              \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{;}
          \OperatorTok{\}}
      \OperatorTok{\};}
  
      \DataTypeTok{int}\NormalTok{ ch}\OperatorTok{[}\NormalTok{\_}\OperatorTok{][}\DecValTok{2}\OperatorTok{],}\NormalTok{ fa}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ si}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ rt}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{;} \DataTypeTok{data\_t}\NormalTok{ v}\OperatorTok{[}\NormalTok{\_}\OperatorTok{];}
      \DataTypeTok{short}\NormalTok{ val}\OperatorTok{[}\NormalTok{\_}\OperatorTok{];}
      \DataTypeTok{bool}\NormalTok{ tag\_rev}\OperatorTok{[}\NormalTok{\_}\OperatorTok{];} \DataTypeTok{short}\NormalTok{ tag\_ret}\OperatorTok{[}\NormalTok{\_}\OperatorTok{];}
      \PreprocessorTok{\#define ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{0}\OperatorTok{])}
      \PreprocessorTok{\#define rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{1}\OperatorTok{])}
      \PreprocessorTok{\#define maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\DecValTok{1}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{v}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\DataTypeTok{data\_t}\OperatorTok{(}\NormalTok{val}\OperatorTok{[}\NormalTok{o}\OperatorTok{])}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\NormalTok{v}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])}
      \PreprocessorTok{\#define get}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]][}\DecValTok{1}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{==}\PreprocessorTok{ }\NormalTok{o}\OperatorTok{)}
      \DataTypeTok{int}\NormalTok{ make}\OperatorTok{()\{}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{Mem}\OperatorTok{.}\NormalTok{empty}\OperatorTok{())\{}
              \DataTypeTok{int}\NormalTok{ o }\OperatorTok{=}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{top}\OperatorTok{();}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{pop}\OperatorTok{();}
  \NormalTok{            tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ none}\OperatorTok{;}
  \NormalTok{            tag\_rev}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \KeywordTok{false}\OperatorTok{;}
  \NormalTok{            ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{0}\OperatorTok{]} \OperatorTok{=}\NormalTok{ si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ val}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{            v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DataTypeTok{data\_t}\OperatorTok{();}
              \ControlFlowTok{return}\NormalTok{ o}\OperatorTok{;}
          \OperatorTok{\}} \ControlFlowTok{else} \OperatorTok{\{}
  \NormalTok{            tot}\OperatorTok{++;}
  \NormalTok{            tag\_ret}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ none}\OperatorTok{;}
  \NormalTok{            tag\_rev}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=} \KeywordTok{false}\OperatorTok{;}
  \NormalTok{            ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{0}\OperatorTok{]} \OperatorTok{=}\NormalTok{ si}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ val}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=} \DecValTok{0}\OperatorTok{;}
  \NormalTok{            v}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]} \OperatorTok{=} \DataTypeTok{data\_t}\OperatorTok{();}
              \ControlFlowTok{return}\NormalTok{ tot}\OperatorTok{;}
          \OperatorTok{\}}
          
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ recycle}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{)\{} \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{;}\NormalTok{ Mem}\OperatorTok{.}\NormalTok{push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}\NormalTok{ recycle}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{));}\NormalTok{ recycle}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{));} \OperatorTok{\}}
  
      \DataTypeTok{Splay\_t}\OperatorTok{()} \OperatorTok{\{}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ tot }\OperatorTok{=} \DecValTok{0}\OperatorTok{;} \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ tar\_rev}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{)\{}
  \NormalTok{        v}\OperatorTok{[}\NormalTok{o}\OperatorTok{].}\NormalTok{rev}\OperatorTok{();}
  \NormalTok{        swap}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{));}
  \NormalTok{        tag\_rev}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{\^{}=} \DecValTok{1}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ tar\_ret}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{}
  \NormalTok{        v}\OperatorTok{[}\NormalTok{o}\OperatorTok{].}\NormalTok{ret}\OperatorTok{(}\NormalTok{V}\OperatorTok{,}\NormalTok{ si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]);}
  \NormalTok{        val}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ V}\OperatorTok{;}
  \NormalTok{        tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ V}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ push}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{!=}\NormalTok{ none}\OperatorTok{)\{}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{))}\NormalTok{ tar\_ret}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]);}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{))}\NormalTok{ tar\_ret}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]);}
  \NormalTok{            tag\_ret}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ none}\OperatorTok{;}
          \OperatorTok{\}}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{tag\_rev}\OperatorTok{[}\NormalTok{o}\OperatorTok{])\{}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{))}\NormalTok{tar\_rev}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{));}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{))}\NormalTok{tar\_rev}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{));}
  \NormalTok{            tag\_rev}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DecValTok{0}\OperatorTok{;}
          \OperatorTok{\}}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ rotate}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{)\{}
          \DataTypeTok{int}\NormalTok{ p }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{],}\NormalTok{ gp }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]],}\NormalTok{ chk }\OperatorTok{=}\NormalTok{ get}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
  \NormalTok{        ch}\OperatorTok{[}\NormalTok{p}\OperatorTok{][}\NormalTok{chk}\OperatorTok{]} \OperatorTok{=}\NormalTok{ ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk }\OperatorTok{\^{}} \DecValTok{1}\OperatorTok{];}\NormalTok{ fa}\OperatorTok{[}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk }\OperatorTok{\^{}} \DecValTok{1}\OperatorTok{]]} \OperatorTok{=}\NormalTok{ p}\OperatorTok{;}
  \NormalTok{        ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\NormalTok{chk }\OperatorTok{\^{}} \DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ p}\OperatorTok{;}\NormalTok{ fa}\OperatorTok{[}\NormalTok{p}\OperatorTok{]} \OperatorTok{=}\NormalTok{ o}\OperatorTok{;}
  \NormalTok{        fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ gp}\OperatorTok{;} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{gp}\OperatorTok{)}\NormalTok{ ch}\OperatorTok{[}\NormalTok{gp}\OperatorTok{][}\NormalTok{ch}\OperatorTok{[}\NormalTok{gp}\OperatorTok{][}\DecValTok{1}\OperatorTok{]} \OperatorTok{==}\NormalTok{ p}\OperatorTok{]} \OperatorTok{=}\NormalTok{ o}\OperatorTok{;}
  \NormalTok{        maintain}\OperatorTok{(}\NormalTok{p}\OperatorTok{);}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ splay}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ tgp }\OperatorTok{=} \DecValTok{0}\OperatorTok{)\{}
          \ControlFlowTok{for}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ f }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{];}\NormalTok{ f }\OperatorTok{=}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{],}\NormalTok{ f }\OperatorTok{!=}\NormalTok{ tgp}\OperatorTok{;}\NormalTok{ rotate}\OperatorTok{(}\NormalTok{o}\OperatorTok{))\{}
  \NormalTok{            push}\OperatorTok{(}\NormalTok{f}\OperatorTok{);}\NormalTok{ push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{fa}\OperatorTok{[}\NormalTok{f}\OperatorTok{]} \OperatorTok{!=}\NormalTok{ tgp}\OperatorTok{)}\NormalTok{ rotate}\OperatorTok{(}\NormalTok{get}\OperatorTok{(}\NormalTok{o}\OperatorTok{)} \OperatorTok{==}\NormalTok{ get}\OperatorTok{(}\NormalTok{f}\OperatorTok{)} \OperatorTok{?}\NormalTok{ f }\OperatorTok{:}\NormalTok{ o}\OperatorTok{);}
          \OperatorTok{\}}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{tgp}\OperatorTok{)}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ o}\OperatorTok{;} \CommentTok{// changed \textasciigrave{}rt = tgp\textasciigrave{}  to \textasciigrave{}rt = o\textasciigrave{}.}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ build\_sub}\OperatorTok{(}\DataTypeTok{int} \OperatorTok{\&}\NormalTok{o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ f}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{,} \DataTypeTok{int} \OperatorTok{*}\NormalTok{A}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{L }\OperatorTok{\textgreater{}}\NormalTok{ R}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{;}
          \DataTypeTok{int}\NormalTok{ mid }\OperatorTok{=} \OperatorTok{(}\NormalTok{L }\OperatorTok{+}\NormalTok{ R}\OperatorTok{)} \OperatorTok{\textgreater{}\textgreater{}} \DecValTok{1}\OperatorTok{;}
  \NormalTok{        o }\OperatorTok{=}\NormalTok{ make}\OperatorTok{();}\NormalTok{ fa}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ f}\OperatorTok{;}\NormalTok{ val}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=}\NormalTok{ A}\OperatorTok{[}\NormalTok{mid}\OperatorTok{];}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DataTypeTok{data\_t}\OperatorTok{(}\NormalTok{A}\OperatorTok{[}\NormalTok{mid}\OperatorTok{]);}\NormalTok{ si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{=} \DecValTok{1}\OperatorTok{;}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{L }\OperatorTok{==}\NormalTok{ R}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{;}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{L }\OperatorTok{\textless{}=}\NormalTok{ mid }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{)}\NormalTok{ build\_sub}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ o}\OperatorTok{,}\NormalTok{ L}\OperatorTok{,}\NormalTok{ mid }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ A}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{mid }\OperatorTok{+} \DecValTok{1} \OperatorTok{\textless{}=}\NormalTok{ R}\OperatorTok{)}\NormalTok{ build\_sub}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ o}\OperatorTok{,}\NormalTok{ mid }\OperatorTok{+} \DecValTok{1}\OperatorTok{,}\NormalTok{ R}\OperatorTok{,}\NormalTok{ A}\OperatorTok{);}
  \NormalTok{        maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \OperatorTok{\}} 
      \DataTypeTok{void}\NormalTok{ build}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{,} \DataTypeTok{int} \OperatorTok{*}\NormalTok{A}\OperatorTok{)\{} 
  \NormalTok{        build\_sub}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,} \DecValTok{0}\OperatorTok{,}\NormalTok{ L}\OperatorTok{,}\NormalTok{ R}\OperatorTok{,}\NormalTok{ A}\OperatorTok{);} 
      \OperatorTok{\}}
      
      \DataTypeTok{int}\NormalTok{ insert}\OperatorTok{(}\DataTypeTok{int} \OperatorTok{\&}\NormalTok{o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ f}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ target}\OperatorTok{,} \DataTypeTok{int} \OperatorTok{*}\NormalTok{A}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ len}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ build\_sub}\OperatorTok{(}\NormalTok{o}\OperatorTok{,}\NormalTok{ f}\OperatorTok{,} \DecValTok{1}\OperatorTok{,}\NormalTok{ len}\OperatorTok{,}\NormalTok{ A}\OperatorTok{),}\NormalTok{ o}\OperatorTok{;}
          \DataTypeTok{int}\NormalTok{ r }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}\NormalTok{ push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{target }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])}\NormalTok{ r }\OperatorTok{=}\NormalTok{ insert}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ o}\OperatorTok{,}\NormalTok{ target}\OperatorTok{,}\NormalTok{ A}\OperatorTok{,}\NormalTok{ len}\OperatorTok{);}
          \ControlFlowTok{else}\NormalTok{ r }\OperatorTok{=}\NormalTok{ insert}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ o}\OperatorTok{,}\NormalTok{ target }\OperatorTok{{-}}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ A}\OperatorTok{,}\NormalTok{ len}\OperatorTok{);}
  \NormalTok{        maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ r}\OperatorTok{;}
      \OperatorTok{\}} \DataTypeTok{void}\NormalTok{ insert}\OperatorTok{(}\DataTypeTok{int} \OperatorTok{*}\NormalTok{A}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ len}\OperatorTok{)} \OperatorTok{\{} \DataTypeTok{int}\NormalTok{ r }\OperatorTok{=}\NormalTok{ insert}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,} \DecValTok{0}\OperatorTok{,}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ A}\OperatorTok{,}\NormalTok{ len}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{r}\OperatorTok{);} \OperatorTok{\}}
  
      \DataTypeTok{int}\NormalTok{ find}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ k}\OperatorTok{)\{}
  \NormalTok{        push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{k }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])} \ControlFlowTok{return}\NormalTok{ find}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ k}\OperatorTok{);}
          \ControlFlowTok{else} \OperatorTok{\{}
              \ControlFlowTok{if}\OperatorTok{(}\NormalTok{k }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{+} \DecValTok{1}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ o}\OperatorTok{;}
              \ControlFlowTok{else} \ControlFlowTok{return}\NormalTok{ find}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ k }\OperatorTok{{-}} \DecValTok{1} \OperatorTok{{-}}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]);}
          \OperatorTok{\}}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ Make\_Range}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{)\{}
          \DataTypeTok{int}\NormalTok{ per }\OperatorTok{=}\NormalTok{ find}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ L }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{),}\NormalTok{ suf }\OperatorTok{=}\NormalTok{ find}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ R }\OperatorTok{+} \DecValTok{1}\OperatorTok{);}
  \NormalTok{        splay}\OperatorTok{(}\NormalTok{per}\OperatorTok{);}\NormalTok{ splay}\OperatorTok{(}\NormalTok{suf}\OperatorTok{,}\NormalTok{ rt}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ erase}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{)\{}
  \NormalTok{        Make\_Range}\OperatorTok{(}\NormalTok{L}\OperatorTok{,}\NormalTok{ R}\OperatorTok{);}
          \DataTypeTok{int} \OperatorTok{\&}\NormalTok{ target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}
  \NormalTok{        recycle}\OperatorTok{(}\NormalTok{target}\OperatorTok{);}\NormalTok{ target }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rt}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ rev}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{)\{}
  \NormalTok{        Make\_Range}\OperatorTok{(}\NormalTok{L}\OperatorTok{,}\NormalTok{ R}\OperatorTok{);}
          \DataTypeTok{int} \OperatorTok{\&}\NormalTok{ target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}
  \NormalTok{        tar\_rev}\OperatorTok{(}\NormalTok{target}\OperatorTok{);}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rt}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ ret}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{}
  \NormalTok{        Make\_Range}\OperatorTok{(}\NormalTok{L}\OperatorTok{,}\NormalTok{ R}\OperatorTok{);}
          \DataTypeTok{int} \OperatorTok{\&}\NormalTok{ target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}
  \NormalTok{        tar\_ret}\OperatorTok{(}\NormalTok{target}\OperatorTok{,}\NormalTok{ V}\OperatorTok{);}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{rt}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ query\_sum}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ L}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ R}\OperatorTok{)\{}
  \NormalTok{        Make\_Range}\OperatorTok{(}\NormalTok{L}\OperatorTok{,}\NormalTok{ R}\OperatorTok{);}
          \DataTypeTok{int} \OperatorTok{\&}\NormalTok{ target }\OperatorTok{=}\NormalTok{ ls}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{rt}\OperatorTok{));}
          \ControlFlowTok{return}\NormalTok{ v}\OperatorTok{[}\NormalTok{target}\OperatorTok{].}\NormalTok{sum}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ query\_ans}\OperatorTok{()\{}
          \ControlFlowTok{return}\NormalTok{ v}\OperatorTok{[}\NormalTok{rt}\OperatorTok{].}\NormalTok{ans}\OperatorTok{;}
      \OperatorTok{\}}
     \DataTypeTok{void}\NormalTok{ dfs}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ indent }\OperatorTok{=} \DecValTok{0}\OperatorTok{)\{}
      \ControlFlowTok{if}\OperatorTok{(}\NormalTok{o }\OperatorTok{==} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)}\NormalTok{ o }\OperatorTok{=}\NormalTok{ rt}\OperatorTok{;}
      \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)}  \OperatorTok{\{}\NormalTok{ cerr }\OperatorTok{\textless{}\textless{}}\NormalTok{ string}\OperatorTok{(}\NormalTok{indent}\OperatorTok{,} \CharTok{\textquotesingle{} \textquotesingle{}}\OperatorTok{)} \OperatorTok{\textless{}\textless{}} \StringTok{"\# null"} \OperatorTok{\textless{}\textless{}}\NormalTok{ endl}\OperatorTok{;} \ControlFlowTok{return} \OperatorTok{;} \OperatorTok{\}}
  \NormalTok{    push}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \ControlFlowTok{if}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{))} \OtherTok{assert}\OperatorTok{(}\NormalTok{fa}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{==}\NormalTok{ o}\OperatorTok{);}\NormalTok{ dfs}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ indent }\OperatorTok{+} \DecValTok{10}\OperatorTok{);}
  \NormalTok{    cerr }\OperatorTok{\textless{}\textless{}}\NormalTok{ string}\OperatorTok{(}\NormalTok{indent}\OperatorTok{,} \CharTok{\textquotesingle{} \textquotesingle{}}\OperatorTok{)} \OperatorTok{\textless{}\textless{}} \StringTok{"\# v="} \OperatorTok{\textless{}\textless{}}\NormalTok{ val}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{\textless{}\textless{}} \StringTok{" ans="} \OperatorTok{\textless{}\textless{}}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{].}\NormalTok{ans }\OperatorTok{\textless{}\textless{}}\NormalTok{ endl}\OperatorTok{;}
      \ControlFlowTok{if}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{))} \OtherTok{assert}\OperatorTok{(}\NormalTok{fa}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{==}\NormalTok{ o}\OperatorTok{);}\NormalTok{ dfs}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ indent }\OperatorTok{+} \DecValTok{10}\OperatorTok{);}
      \OperatorTok{\}}
  \OperatorTok{\};}
  \DataTypeTok{Splay\_t}\NormalTok{ t}\OperatorTok{;}
  \DataTypeTok{int}\NormalTok{ A}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ n}\OperatorTok{,}\NormalTok{ m}\OperatorTok{;}
  \DataTypeTok{char}\NormalTok{ opt}\OperatorTok{[}\DecValTok{100}\OperatorTok{];}
  \DataTypeTok{int}\NormalTok{ main}\OperatorTok{()\{} \CommentTok{//freopen(".in", "r", stdin); freopen(".out", "w", stdout);}
  \NormalTok{    Read}\OperatorTok{(}\NormalTok{n}\OperatorTok{)(}\NormalTok{m}\OperatorTok{);}\NormalTok{ n }\OperatorTok{+=} \DecValTok{2}\OperatorTok{;}\NormalTok{ rep}\OperatorTok{(}\NormalTok{i}\OperatorTok{,} \DecValTok{2}\OperatorTok{,}\NormalTok{ n }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{)}\NormalTok{ Read}\OperatorTok{(}\NormalTok{A}\OperatorTok{[}\NormalTok{i}\OperatorTok{]);} 
  \NormalTok{    A}\OperatorTok{[}\DecValTok{1}\OperatorTok{]} \OperatorTok{=}\NormalTok{ A}\OperatorTok{[}\NormalTok{n}\OperatorTok{]} \OperatorTok{=}\NormalTok{ none}\OperatorTok{;} \CommentTok{// added line \textasciigrave{}A[1] = A[n] = {-}inf\textasciigrave{}. }
  \NormalTok{    t}\OperatorTok{.}\NormalTok{build}\OperatorTok{(}\DecValTok{1}\OperatorTok{,}\NormalTok{ n}\OperatorTok{,}\NormalTok{ A}\OperatorTok{);}
  \NormalTok{    rep}\OperatorTok{(}\NormalTok{tt}\OperatorTok{,} \DecValTok{1}\OperatorTok{,}\NormalTok{ m}\OperatorTok{)\{}
  \NormalTok{        scanf}\OperatorTok{(}\StringTok{"}\SpecialCharTok{\%s}\StringTok{"}\OperatorTok{,}\NormalTok{ opt}\OperatorTok{);} \DataTypeTok{char}\NormalTok{ sign0 }\OperatorTok{=}\NormalTok{ opt}\OperatorTok{[}\DecValTok{0}\OperatorTok{],}\NormalTok{ sign1 }\OperatorTok{=}\NormalTok{ opt}\OperatorTok{[}\DecValTok{3}\OperatorTok{];}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{sign0 }\OperatorTok{==} \CharTok{\textquotesingle{}I\textquotesingle{}}\OperatorTok{)} \OperatorTok{\{} \CommentTok{// Insert a sequence.}
              \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{;}\NormalTok{ Read}\OperatorTok{(}\NormalTok{pos}\OperatorTok{)(}\NormalTok{tot}\OperatorTok{);}\NormalTok{ rep}\OperatorTok{(}\NormalTok{i}\OperatorTok{,} \DecValTok{1}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{)}\NormalTok{ Read}\OperatorTok{(}\NormalTok{A}\OperatorTok{[}\NormalTok{i}\OperatorTok{]);}\NormalTok{ pos}\OperatorTok{++;}
  \NormalTok{            t}\OperatorTok{.}\NormalTok{insert}\OperatorTok{(}\NormalTok{A}\OperatorTok{,}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{);}
          \OperatorTok{\}} \ControlFlowTok{else} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{sign0 }\OperatorTok{==} \CharTok{\textquotesingle{}D\textquotesingle{}}\OperatorTok{)\{} \CommentTok{// Delete a sequence.}
              \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{;}\NormalTok{ Read}\OperatorTok{(}\NormalTok{pos}\OperatorTok{)(}\NormalTok{tot}\OperatorTok{);}\NormalTok{ pos}\OperatorTok{++;}
  \NormalTok{            t}\OperatorTok{.}\NormalTok{erase}\OperatorTok{(}\NormalTok{pos}\OperatorTok{,}\NormalTok{ pos }\OperatorTok{+}\NormalTok{ tot }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{);}
          \OperatorTok{\}} \ControlFlowTok{else} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{sign0 }\OperatorTok{==} \CharTok{\textquotesingle{}R\textquotesingle{}}\OperatorTok{)\{} \CommentTok{// Reverse a sequence.}
              \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{;}\NormalTok{ Read}\OperatorTok{(}\NormalTok{pos}\OperatorTok{)(}\NormalTok{tot}\OperatorTok{);}\NormalTok{ pos}\OperatorTok{++;}
  \NormalTok{            t}\OperatorTok{.}\NormalTok{rev}\OperatorTok{(}\NormalTok{pos}\OperatorTok{,}\NormalTok{ tot }\OperatorTok{+}\NormalTok{ pos }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{);}
          \OperatorTok{\}} \ControlFlowTok{else} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{sign0 }\OperatorTok{==} \CharTok{\textquotesingle{}G\textquotesingle{}}\OperatorTok{)\{} \CommentTok{// calc the sum of sequence.}
              \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{;}\NormalTok{ Read}\OperatorTok{(}\NormalTok{pos}\OperatorTok{)(}\NormalTok{tot}\OperatorTok{);}\NormalTok{ pos}\OperatorTok{++;}
  \NormalTok{            printf}\OperatorTok{(}\StringTok{"}\SpecialCharTok{\%d\textbackslash{}n}\StringTok{"}\OperatorTok{,}\NormalTok{ t}\OperatorTok{.}\NormalTok{query\_sum}\OperatorTok{(}\NormalTok{pos}\OperatorTok{,}\NormalTok{ pos }\OperatorTok{+}\NormalTok{ tot }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{));}
          \OperatorTok{\}} \ControlFlowTok{else} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{sign1 }\OperatorTok{==} \CharTok{\textquotesingle{}{-}\textquotesingle{}}\OperatorTok{)\{} \CommentTok{// calc the max sum sub sequence.}
  \NormalTok{            printf}\OperatorTok{(}\StringTok{"}\SpecialCharTok{\%d\textbackslash{}n}\StringTok{"}\OperatorTok{,}\NormalTok{ t}\OperatorTok{.}\NormalTok{query\_ans}\OperatorTok{());}
          \OperatorTok{\}} \ControlFlowTok{else} \OperatorTok{\{} \CommentTok{// make same on the sequence.}
              \DataTypeTok{int}\NormalTok{ pos}\OperatorTok{,}\NormalTok{ tot}\OperatorTok{,}\NormalTok{ c}\OperatorTok{;}\NormalTok{ Read}\OperatorTok{(}\NormalTok{pos}\OperatorTok{)(}\NormalTok{tot}\OperatorTok{)(}\NormalTok{c}\OperatorTok{);}\NormalTok{ pos}\OperatorTok{++;}
  \NormalTok{            t}\OperatorTok{.}\NormalTok{ret}\OperatorTok{(}\NormalTok{pos}\OperatorTok{,}\NormalTok{ pos }\OperatorTok{+}\NormalTok{ tot }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ c}\OperatorTok{);}
          \OperatorTok{\}}
      \OperatorTok{\}}
      \ControlFlowTok{return} \DecValTok{0}\OperatorTok{;}
  \OperatorTok{\}}
  \end{Highlighting}
  \end{Shaded}
  
  \subsubsection{非旋 Treap}\label{ux975eux65cb-treap}
  
  udp：2021/01/02. u1s1，这东西又短 又小 又快。\texttt{splay} 可能真的只有
  \texttt{LCT} 里面才出场了。
  
  \begin{Shaded}
  \begin{Highlighting}[]
  \DataTypeTok{int}\NormalTok{ rand}\OperatorTok{()\{}
      \AttributeTok{static} \DataTypeTok{int}\NormalTok{ seed }\OperatorTok{=} \DecValTok{1020031005}\OperatorTok{;}
      \ControlFlowTok{return}\NormalTok{ seed }\OperatorTok{=} \OperatorTok{((}\NormalTok{seed }\OperatorTok{+}\DecValTok{0}\BuiltInTok{ll}\OperatorTok{+} \DecValTok{20031006}\OperatorTok{)} \OperatorTok{\%} \DecValTok{998244353}\OperatorTok{);}
  \OperatorTok{\}}
  \KeywordTok{namespace}\NormalTok{ FHQ}\OperatorTok{\{}
      \AttributeTok{const} \DataTypeTok{int}\NormalTok{ \_ }\OperatorTok{=} \FloatTok{1e5} \OperatorTok{+} \DecValTok{100}\OperatorTok{;}
      \DataTypeTok{int}\NormalTok{ ch}\OperatorTok{[}\NormalTok{\_}\OperatorTok{][}\DecValTok{2}\OperatorTok{],}\NormalTok{ si}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ v}\OperatorTok{[}\NormalTok{\_}\OperatorTok{],}\NormalTok{ tot }\OperatorTok{=} \DecValTok{0}\OperatorTok{,}\NormalTok{ rt }\OperatorTok{=} \DecValTok{0}\OperatorTok{;}
      \PreprocessorTok{\#define ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{0}\OperatorTok{])}
      \PreprocessorTok{\#define rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{ch}\OperatorTok{[}\NormalTok{o}\OperatorTok{][}\DecValTok{1}\OperatorTok{])}
      \PreprocessorTok{\#define maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\DataTypeTok{void}\OperatorTok{)(}\NormalTok{si}\OperatorTok{[}\NormalTok{o}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]}\PreprocessorTok{ }\OperatorTok{+}\PreprocessorTok{ }\DecValTok{1}\OperatorTok{)}
      \PreprocessorTok{\#define make}\OperatorTok{(}\NormalTok{vs}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(++}\NormalTok{tot}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{v}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{vs}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{si}\OperatorTok{[}\NormalTok{tot}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\DecValTok{1}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{0}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\NormalTok{ch}\OperatorTok{[}\NormalTok{tot}\OperatorTok{][}\DecValTok{1}\OperatorTok{]}\PreprocessorTok{ }\OperatorTok{=}\PreprocessorTok{ }\DecValTok{0}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{tot}\OperatorTok{)}
      \PreprocessorTok{\#define mg}\OperatorTok{(}\NormalTok{a}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{b}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{c}\OperatorTok{)}\PreprocessorTok{ }\OperatorTok{(}\NormalTok{merge}\OperatorTok{(}\NormalTok{merge}\OperatorTok{(}\NormalTok{a}\OperatorTok{,}\PreprocessorTok{ }\NormalTok{b}\OperatorTok{),}\PreprocessorTok{ }\NormalTok{c}\OperatorTok{))}
      \DataTypeTok{void}\NormalTok{ split}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ o}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ V}\OperatorTok{,} \DataTypeTok{int} \OperatorTok{\&}\NormalTok{x}\OperatorTok{,} \DataTypeTok{int} \OperatorTok{\&}\NormalTok{y}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(!}\NormalTok{o}\OperatorTok{)} \ControlFlowTok{return} \OperatorTok{(}\DataTypeTok{void}\OperatorTok{)(}\NormalTok{x }\OperatorTok{=}\NormalTok{ y }\OperatorTok{=} \DecValTok{0}\OperatorTok{);}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{v}\OperatorTok{[}\NormalTok{o}\OperatorTok{]} \OperatorTok{\textless{}=}\NormalTok{ V}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{=}\NormalTok{ o}\OperatorTok{,}\NormalTok{ split}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ V}\OperatorTok{,}\NormalTok{ rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ y}\OperatorTok{),}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
          \ControlFlowTok{return}\NormalTok{ y }\OperatorTok{=}\NormalTok{ o}\OperatorTok{,}\NormalTok{ split}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{),}\NormalTok{ V}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)),}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{o}\OperatorTok{);}
      \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ merge}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ x}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ y}\OperatorTok{)\{}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{x }\OperatorTok{==} \DecValTok{0} \OperatorTok{||}\NormalTok{ y }\OperatorTok{==} \DecValTok{0}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{+}\NormalTok{ y}\OperatorTok{;}
          \ControlFlowTok{if}\OperatorTok{(}\NormalTok{rand}\OperatorTok{()} \OperatorTok{\%} \OperatorTok{(}\NormalTok{si}\OperatorTok{[}\NormalTok{x}\OperatorTok{]} \OperatorTok{+}\NormalTok{ si}\OperatorTok{[}\NormalTok{y}\OperatorTok{])} \OperatorTok{+} \DecValTok{1} \OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{x}\OperatorTok{])} \ControlFlowTok{return}\NormalTok{ rs}\OperatorTok{(}\NormalTok{x}\OperatorTok{)} \OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{rs}\OperatorTok{(}\NormalTok{x}\OperatorTok{),}\NormalTok{ y}\OperatorTok{),}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{x}\OperatorTok{),}\NormalTok{ x}\OperatorTok{;}
          \ControlFlowTok{else} \ControlFlowTok{return}\NormalTok{ ls}\OperatorTok{(}\NormalTok{y}\OperatorTok{)} \OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{x}\OperatorTok{,}\NormalTok{ ls}\OperatorTok{(}\NormalTok{y}\OperatorTok{)),}\NormalTok{ maintain}\OperatorTok{(}\NormalTok{y}\OperatorTok{),}\NormalTok{ y}\OperatorTok{;}
      \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ ins}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ x}\OperatorTok{)\{} \DataTypeTok{int}\NormalTok{ t0}\OperatorTok{,}\NormalTok{ t1 }\OperatorTok{=}\NormalTok{ make}\OperatorTok{(}\NormalTok{x}\OperatorTok{),}\NormalTok{ t2}\OperatorTok{;}\NormalTok{ split}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ t0}\OperatorTok{,}\NormalTok{ t2}\OperatorTok{);}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ mg}\OperatorTok{(}\NormalTok{t0}\OperatorTok{,}\NormalTok{ t1}\OperatorTok{,}\NormalTok{ t2}\OperatorTok{);} \OperatorTok{\}}
      \DataTypeTok{void}\NormalTok{ erase}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{} \DataTypeTok{int}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{,}\NormalTok{ z}\OperatorTok{;}\NormalTok{ split}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ V}\OperatorTok{,}\NormalTok{ y}\OperatorTok{,}\NormalTok{ z}\OperatorTok{);}\NormalTok{ split}\OperatorTok{(}\NormalTok{y}\OperatorTok{,}\NormalTok{ V }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);}\NormalTok{ y }\OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{ls}\OperatorTok{(}\NormalTok{y}\OperatorTok{),}\NormalTok{ rs}\OperatorTok{(}\NormalTok{y}\OperatorTok{));}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ mg}\OperatorTok{(}\NormalTok{x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{,}\NormalTok{ z}\OperatorTok{);} \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ rank}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{)} \OperatorTok{\{} \DataTypeTok{int}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{;}\NormalTok{ split}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ V }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \DataTypeTok{int}\NormalTok{ res }\OperatorTok{=}\NormalTok{ si}\OperatorTok{[}\NormalTok{x}\OperatorTok{];}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res }\OperatorTok{+} \DecValTok{1}\OperatorTok{;} \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ select}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{,} \DataTypeTok{int}\NormalTok{ o }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)\{} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{o }\OperatorTok{==} \OperatorTok{{-}}\DecValTok{1}\OperatorTok{)}\NormalTok{ o }\OperatorTok{=}\NormalTok{ rt}\OperatorTok{;} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{V }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)])} \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{V}\OperatorTok{,}\NormalTok{ ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{));} \ControlFlowTok{else} \OperatorTok{\{} \ControlFlowTok{if}\OperatorTok{(}\NormalTok{V }\OperatorTok{\textless{}=}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{+} \DecValTok{1}\OperatorTok{)} \ControlFlowTok{return}\NormalTok{ v}\OperatorTok{[}\NormalTok{o}\OperatorTok{];} \ControlFlowTok{else} \ControlFlowTok{return}\NormalTok{ select}\OperatorTok{(}\NormalTok{V }\OperatorTok{{-}}\NormalTok{ si}\OperatorTok{[}\NormalTok{ls}\OperatorTok{(}\NormalTok{o}\OperatorTok{)]} \OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ rs}\OperatorTok{(}\NormalTok{o}\OperatorTok{));} \OperatorTok{\}} \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ pred}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{} \DataTypeTok{int}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{;}\NormalTok{ split}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ V }\OperatorTok{{-}} \DecValTok{1}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \DataTypeTok{int}\NormalTok{ res }\OperatorTok{=}\NormalTok{ select}\OperatorTok{(}\NormalTok{si}\OperatorTok{[}\NormalTok{x}\OperatorTok{],}\NormalTok{ x}\OperatorTok{);}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{;} \OperatorTok{\}}
      \DataTypeTok{int}\NormalTok{ succ}\OperatorTok{(}\DataTypeTok{int}\NormalTok{ V}\OperatorTok{)\{} \DataTypeTok{int}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{;}\NormalTok{ split}\OperatorTok{(}\NormalTok{rt}\OperatorTok{,}\NormalTok{ V}\OperatorTok{,}\NormalTok{ x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \DataTypeTok{int}\NormalTok{ res }\OperatorTok{=}\NormalTok{ select}\OperatorTok{(}\DecValTok{1}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);}\NormalTok{ rt }\OperatorTok{=}\NormalTok{ merge}\OperatorTok{(}\NormalTok{x}\OperatorTok{,}\NormalTok{ y}\OperatorTok{);} \ControlFlowTok{return}\NormalTok{ res}\OperatorTok{;} \OperatorTok{\}}
  \OperatorTok{\}} \KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ ins }\OperatorTok{;}\KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ erase }\OperatorTok{;}\KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ select }\OperatorTok{;}\KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ rank }\OperatorTok{;}\KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ pred }\OperatorTok{;}\KeywordTok{using}\NormalTok{ FHQ}\OperatorTok{::}\NormalTok{ succ }\OperatorTok{;}
  \end{Highlighting}
  \end{Shaded}
  
  
  \end{document}
[INFO] [makePDF] LaTeX run number 1
[INFO] [makePDF] LaTeX output
  This is XeTeX, Version 3.141592653-2.6-0.999995 (TeX Live 2023/Debian) (preloaded format=xelatex)
   restricted \write18 enabled.
  entering extended mode
  (.../input.tex
  LaTeX2e <2023-11-01> patch level 1
  L3 programming layer <2024-01-22>
  (.../article.cls
  Document Class: article 2023/05/17 v1.4n Standard LaTeX document class
  (.../[system]
  (.../xcolor.sty
  (.../color.cfg)
  (.../xetex.def)
  (.../[system]
  (.../geometry.sty
  (.../keyval.sty)
  (.../ifvtex.sty
  (.../iftex.sty)))
  (.../amsmath.sty
  For additional information on amsmath, use the `?' option.
  (.../amstext.sty
  (.../amsgen.sty))
  (.../amsbsy.sty)
  (.../amsopn.sty))
  (.../amssymb.sty
  (.../amsfonts.sty))
  (.../unicode-math.sty
  (.../expl3.sty
  (.../l3backend-xetex.def))
  (.../unicode-math-xetex.sty
  (.../xparse.sty)
  (.../l3keys2e.sty)
  (.../fontspec.sty
  (.../fontspec-xetex.sty
  (.../fontenc.sty)
  (.../fontspec.cfg)))
  (.../fix-cm.sty
  (.../ts1enc.def))
  (.../unicode-math-table.tex)))
  (.../lmodern.sty)
  (.../xeCJK.sty
  (.../ctexhook.sty)
  (.../xtemplate.sty)
  (.../xeCJK.cfg))
  (.../upquote.sty
  (.../textcomp.sty))
  (.../microtype.sty
  (.../etoolbox.sty)
  (.../microtype-xetex.def)
  (.../microtype.cfg))
  (.../setspace.sty)
  (.../parskip.sty
  (.../kvoptions.sty
  (.../ltxcmds.sty)
  (.../kvsetkeys.sty)))
  (.../fancyvrb.sty)
  (.../soul.sty
  (.../soul-ori.sty)
  (.../infwarerr.sty)
  (.../etexcmds.sty))
  (.../xeCJKfntef.sty
  (.../ulem.sty))
  (.../bookmark.sty
  (.../hyperref.sty
  (.../kvdefinekeys.sty)
  (.../pdfescape.sty
  (.../pdftexcmds.sty))
  (.../hycolor.sty)
  (.../auxhook.sty)
  (.../nameref.sty
  (.../refcount.sty)
  (.../gettitlestring.sty))
  (.../pd1enc.def)
  (.../intcalc.sty)
  (.../puenc.def)
  (.../url.sty)
  (.../bitset.sty
  (.../bigintcalc.sty))
  (.../atbegshi-ltx.sty))
  (.../hxetex.def
  (.../stringenc.sty)
  (.../rerunfilecheck.sty
  (.../atveryend-ltx.sty)
  (.../uniquecounter.sty)))
  (.../bkm-dvipdfm.def))
  (.../xurl.sty)
  No file input.aux.
  *geometry* driver: auto-detecting
  *geometry* detected driver: xetex
  (.../mt-LatinModernRoman.cfg)
  
  Package hyperref Warning: Rerun to get /PageLabels entry.
  
  (.../omllmm.fd)
  (.../umsa.fd)
  (.../mt-msa.cfg)
  (.../umsb.fd)
  (.../mt-msb.cfg)
  
  Package xeCJK Warning: Unknown CJK family `\CJKttdefault' is being ignored.
  (xeCJK)                
  (xeCJK)                Try to use `\setCJKmonofont[<...>]{<...>}' to define
  (xeCJK)                it.
  
  
  LaTeX Font Warning: Font shape `TU/ARPLUKaiCN(0)/b/n' undefined
  (Font)              using `TU/ARPLUKaiCN(0)/m/n' instead on input line 130.
  
  [1] [2] [3] [4] [5] [6] [7] [8] (.../input.aux)
  
  LaTeX Font Warning: Some font shapes were not available, defaults substituted.
  
  
  LaTeX Warning: Label(s) may have changed. Rerun to get cross-references right.
  
   )
  Output written on .../input.pdf (8 pages).
  Transcript written on .../input.log.
[INFO] [makePDF] Rerun needed
  Package hyperref Warning: Rerun to get /PageLabels entry.
  LaTeX Warning: Label(s) may have changed. Rerun to get cross-references right.
[INFO] [makePDF] LaTeX run number 2
[INFO] [makePDF] LaTeX output
  This is XeTeX, Version 3.141592653-2.6-0.999995 (TeX Live 2023/Debian) (preloaded format=xelatex)
   restricted \write18 enabled.
  entering extended mode
  (.../input.tex
  LaTeX2e <2023-11-01> patch level 1
  L3 programming layer <2024-01-22>
  (.../article.cls
  Document Class: article 2023/05/17 v1.4n Standard LaTeX document class
  (.../[system]
  (.../xcolor.sty
  (.../color.cfg)
  (.../xetex.def)
  (.../[system]
  (.../geometry.sty
  (.../keyval.sty)
  (.../ifvtex.sty
  (.../iftex.sty)))
  (.../amsmath.sty
  For additional information on amsmath, use the `?' option.
  (.../amstext.sty
  (.../amsgen.sty))
  (.../amsbsy.sty)
  (.../amsopn.sty))
  (.../amssymb.sty
  (.../amsfonts.sty))
  (.../unicode-math.sty
  (.../expl3.sty
  (.../l3backend-xetex.def))
  (.../unicode-math-xetex.sty
  (.../xparse.sty)
  (.../l3keys2e.sty)
  (.../fontspec.sty
  (.../fontspec-xetex.sty
  (.../fontenc.sty)
  (.../fontspec.cfg)))
  (.../fix-cm.sty
  (.../ts1enc.def))
  (.../unicode-math-table.tex)))
  (.../lmodern.sty)
  (.../xeCJK.sty
  (.../ctexhook.sty)
  (.../xtemplate.sty)
  (.../xeCJK.cfg))
  (.../upquote.sty
  (.../textcomp.sty))
  (.../microtype.sty
  (.../etoolbox.sty)
  (.../microtype-xetex.def)
  (.../microtype.cfg))
  (.../setspace.sty)
  (.../parskip.sty
  (.../kvoptions.sty
  (.../ltxcmds.sty)
  (.../kvsetkeys.sty)))
  (.../fancyvrb.sty)
  (.../soul.sty
  (.../soul-ori.sty)
  (.../infwarerr.sty)
  (.../etexcmds.sty))
  (.../xeCJKfntef.sty
  (.../ulem.sty))
  (.../bookmark.sty
  (.../hyperref.sty
  (.../kvdefinekeys.sty)
  (.../pdfescape.sty
  (.../pdftexcmds.sty))
  (.../hycolor.sty)
  (.../auxhook.sty)
  (.../nameref.sty
  (.../refcount.sty)
  (.../gettitlestring.sty))
  (.../pd1enc.def)
  (.../intcalc.sty)
  (.../puenc.def)
  (.../url.sty)
  (.../bitset.sty
  (.../bigintcalc.sty))
  (.../atbegshi-ltx.sty))
  (.../hxetex.def
  (.../stringenc.sty)
  (.../rerunfilecheck.sty
  (.../atveryend-ltx.sty)
  (.../uniquecounter.sty)))
  (.../bkm-dvipdfm.def))
  (.../xurl.sty)
  (.../input.aux)
  *geometry* driver: auto-detecting
  *geometry* detected driver: xetex
  (.../mt-LatinModernRoman.cfg)
  (.../omllmm.fd)
  (.../umsa.fd)
  (.../mt-msa.cfg)
  (.../umsb.fd)
  (.../mt-msb.cfg)
  
  Package xeCJK Warning: Unknown CJK family `\CJKttdefault' is being ignored.
  (xeCJK)                
  (xeCJK)                Try to use `\setCJKmonofont[<...>]{<...>}' to define
  (xeCJK)                it.
  
  
  LaTeX Font Warning: Font shape `TU/ARPLUKaiCN(0)/b/n' undefined
  (Font)              using `TU/ARPLUKaiCN(0)/m/n' instead on input line 130.
  
  [1] [2] [3] [4] [5] [6] [7] [8] (.../input.aux)
  
  LaTeX Font Warning: Some font shapes were not available, defaults substituted.
  
   )
  Output written on .../input.pdf (8 pages).
  Transcript written on .../input.log.
</pre>
                                            </details>
                    
                                    </div>
                                </article>
                

                

                

                

            

                
                        </div>
                    </main>
            </div>

                <!-- Footer -->
                <footer id="footer">
                    <p>© 2025 ShuYuMo's Blog by Jiayi Su. All rights reserved.</p>  Powered by <b>MonoPy</b> - Single-Script Blog Generator in Python.
                </footer>
            </div>
        </div>
        
        <!-- Back to top button -->
        <button id="back-to-top" 
                aria-label="Back to top" 
                title="Back to top"
                style="display: none;">
            ↑
        </button>
        
        <!-- JavaScript -->
        <script>
            // Back to top functionality
            (function() {
                const backToTopButton = document.getElementById('back-to-top');
                const scrollThreshold = 300;
                
                function toggleBackToTop() {
                    if (window.scrollY > scrollThreshold) {
                        backToTopButton.style.display = 'block';
                    } else {
                        backToTopButton.style.display = 'none';
                    }
                }
                
                function scrollToTop() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                window.addEventListener('scroll', toggleBackToTop);
                backToTopButton.addEventListener('click', scrollToTop);
            })();
            
            // Clean up redundant spans in code blocks
            document.querySelectorAll('pre code').forEach(codeBlock => {
                // Find all line spans
                const lineSpans = codeBlock.querySelectorAll('span[id^="cb"]');
                
                lineSpans.forEach(lineSpan => {
                    // Check if this line has nested spans that can be simplified
                    const children = Array.from(lineSpan.childNodes);
                    
                    // Skip the anchor link (first child is usually the line number anchor)
                    let contentStart = 0;
                    if (children[0] && children[0].tagName === 'A') {
                        contentStart = 1;
                    }
                    
                    // If there's only one span child after the anchor, unwrap it
                    const contentChildren = children.slice(contentStart);
                    if (contentChildren.length === 1 && contentChildren[0].tagName === 'SPAN') {
                        const spanChild = contentChildren[0];
                        // Move the span's contents directly to the line span
                        while (spanChild.firstChild) {
                            lineSpan.insertBefore(spanChild.firstChild, spanChild);
                        }
                        // Remove the now-empty span
                        spanChild.remove();
                    }
                });
            });
            
            // Code copy functionality
            document.querySelectorAll('pre code').forEach(block => {
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copy';
                button.setAttribute('aria-label', 'Copy code to clipboard');
                
                button.addEventListener('click', function() {
                    navigator.clipboard.writeText(block.textContent).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    }).catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = block.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    });
                });
                
                const pre = block.parentNode;
                pre.style.position = 'relative';
                pre.appendChild(button);
            });
        </script>
    </body>
</html>